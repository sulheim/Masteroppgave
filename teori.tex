%Teori.tex
\section{Theory}
\subsection{Basics of ultrasound images}
The basis of ultrasound imaging is the reflection of ultrasound at tissue boundaries within the body. Ultrasound is sound waves generated by a transducer, and as the wave travels through the body, echoes are generated by partial reflection at every boundary. The amount of reflection depends on the relative change in acoustic impedance at the boundary. The echo is recorded by the transducer, and it is then displayed in the image according its spatial origin. The speed of sound is approximately \SI{1540}{\metre\per\second} for all soft tissue in the body, and it is thus easy to calculate the origin by measuring the time of travel of the echo. The brightness in the image is proportional to the strength of the echo. This is called B-mode(brightness mode), and is the most common imaging mode. 

\subsection{Physics of ultrasound}
Ultrasound is sound waves with frequency above \SI{20}{\kilo\hertz}, which is the upper limit of audible sound. For the purpose of medical imaging, frequencies between \SI{1}{\mega\hertz} and \SI{18}{\mega\hertz} are common. Sound waves are pressure waves, and the pressure fluctuations cause temporal displacement of the medium in which the wave is traveling. For most purposes the displacement is along the direction of travel, this is know as longitudinal waves. Solids can support transverse sound waves, but that is outside the scope of this thesis.  The wavelength , $\lambda$, is determined by the frequency of the source and the phase velocity in the medium, $c$, i.e. $\lambda= \frac{c}{f}$. The phase velocity $c$ is given by

\begin{equation}
\label{phace velocity}
c = \sqrt{\frac{1}{\rho \kappa}},
\end{equation}

where $\rho$ and $\kappa$ are the tissue density and compressibility. For soft human tissue the phase velocity is about \SI{1540}{\metre\per\second}.%, while it is about \SI{4000}{\metre\per\second} for bone.
The compressibility is a measure of the relative change in volume from change in pressure, that is $\kappa = -\frac{1}{V}\frac{\partial V}{\partial p}$. Here $V$ is volume and $p$ pressure. 

The propagation of a sound wave traveling in the x-direction can in a fluid be described by the wave equation, i.e.
\begin{equation}
\label{wave equation}
\frac{\partial^2W}{\partial x^2} = \frac{\rho_0}{G}\frac{\partial^2W}{\partial t^2}.
\end{equation}

Here $W$ is the particle displacement, $\rho_0$ the density of the medium and $G$ the bulk modulus. The bulk modulus is the reciprocal of the compressibility, and is a measure of the volume stiffness. A general solution to this equation is 
\begin{equation}
\label{particle displacement}
W = W_0 \exp^{i(kx - \omega t)},
\end{equation}

where $\omega$ is the angular frequency, $k = \frac{\omega}{c}$ the wave number, and $c$ the phase velocity as given in Equation \eqref{phace velocity}, with $\kappa$ substituted by $\frac{1}{G}$. The pressure variations is then given by particle velocity $u_x = \frac{\partial W}{\partial t}$ as 

\begin{equation}
\label{pressure wave}
p_z = \rho_0 c u_x.
\end{equation}

It is important to emphasize the difference between the phase velocity and the particle velocity. The phase velocity is the velocity of energy carried through the medium, while the particle velocity is the velocity of the local displacement of particles.

The acoustic impedance $Z$ of the medium is defined as the ratio of the pressure to the particle velocity,
\begin{equation}
\label{acoustic impedance}
 Z = \frac{p_x}{u_x} = \rho c.
\end{equation}
   %%%Sjekk fortegn?????????????????

 
\subsection{Reflection}
Reflection provide the basis for ultrasound imaging, and occurs when the wave encounter a planar surface with a change in acoustic impedance. Across this surface both the pressure and particle velocity have to be continuous. From these boundary conditions 
%The acoustic impedance $z$ is given by  
%\begin{equation}
%z = \rho c.
%\end{equation}
the intensity coefficients of the reflected $r_i$ and transmitted $t_i$ wave can be given as \cite{wells1969physical}
\begin{equation}
\label{fresnel}
r_i = \left(\frac{z_2 \cos \theta_i - z_1 \cos \theta_t}{z_1 \cos \theta_t + z_2 \cos \theta_i}\right)^2
\end{equation}

\begin{equation}
\label{fresnel2}
t_i = \frac{4z_2 z_1 \cos^2 \theta_i}{(z_2 \cos \theta_i + z_1 \cos \theta_t)^2}.
\end{equation}

Here $z_1$ and $z_2$ are the acoustic impedance in medium 1 and 2, shown in Figure ?????. The angle of reflection $\theta_r$ is equal the angle of incidence $\theta_i$, while the angle of transmission $\theta_t$ is given by Snell's law\cite{blackstock2000fundamentals}, $ c_2 \sin \theta_i = c_1 \sin \theta_t$. 

\subsection{Absorption}
Loss of kinetic energy to heat from the propagating wave to the surrounding medium is known as absorption. Absorption occur continuously and reduce the amplitude of the wave. For linear propagation of a pressure wave, this can be described as 

\begin{equation}
p(x) = p(0)\exp^{-\alpha_A(\omega)x},
\end{equation} 

where $p(0)$ is the initial pressure amplitude, $alpha_A$ the absorption coefficient and $\omega$ the angular frequency.

For non-linear propagation the absorption depends on the local amplitude, and in the diagnostic intensity range the non-linear interaction is proportional to the square of the intensity\cite{:/content/asa/journal/jasa/97/3/10.1121/1.412091}. Non-linear propagation also affects the shape and frequency spectrum of the propagating wave, and can usually not be ignored for contrast agent applications \cite{Healey2012}. 

%\subsection{Non-linear imaging??}
 
\subsection{Scattering}
Scattering is reflection that occur when the size $d$ of the surface encountered is comparable or smaller than the wavelength. Scattering can arise from inhomogenities in compressibility or density. Scattering reflects the wave in a large range of directions, and the backscattered signal received at the transducer is therefore weak compared to reflected echoes. The magnitude and direction of the scattering depends on the size of the scatterer and increase strongly with the frequency.  

\begin{figure}[h]
  \centering
  \includegraphics[scale=0.8]{figurer\scattering2.png}
  \caption{Fig:Scattering}
\end{figure}
If we consider an incoming plane wave propagating in the direction $hat{i}$, see Figure \ref{Fig:scattering}, the incident pressure, $p_i$, at the scatter located at $\textbf{r_0}$ is then

\begin{equation}
p_i(\textbf{r_0}, t) = p_0\exp^{i(\textbf{r_0k_i}-\omega t)}.
\end{equation}

If we only consider the far field the scattered wave, $p_s$, at the observer at $\textbf{r}$ is given by \cite{Healey2012}

\begin{equation}
p_s(\textbf{r}, t) = f(\hat{r},\hat{i})\frac{\exp^{ik_s(\textbf{r-r_0}}{\abs*{\textbf{r-r_0}}}p_i(\textbf{r_0}, t).
\end{equation}

The $f(\hat{r},\hat{i})$ is the scattering amplitude function. The scattered intensity is

\begin{equation}
I_s = \frac{1}{2}\frac{\abs*{p_s}^2}{\rho c} =\frac{1}{2}\frac{\abs*{p_i}^2}{\rho c}\frac{\abs*f(\hat{r},\hat{i})}^2}{\abs*{\textbf{r-r_0}}^2} = I_i \frac{\abs*{f(\hat{r},\hat{i})}^2}{\abs*{\textbf{r-r_0}}^2},
\end{equation}

where $I_i$ is the incident intensity. The differential scattering cross-section is defined as $\sigma_d = |f(\hat{r},\hat{i})|^2$. The scattering cross section is the integral of the differential cross section over all solid angles, i.e.

\begin{equation}
\label{solid angle}
\sigma_s = \int_{4\pi}\sigma_d \mathrm{d}\Omega.
\end{equation}

The Rayleigh scattering model is the simplest model for scattering of small particles, i.e. particles with a diameter $d << \lambda$. This model do not take damping or resonance effects into account. If we again consider the plane wave, the differential scattering cross section is given by \cite{morse1986theoretical}

\begin{equation}
\label{rayleigh cross section}
\sigma_d = k^4a^6\abs*{\frac{G-G_0}{3G}-\frac{\rho-\rho_0}{2\rho+\rho_0}\cos\theta}^2.
\end{equation} 

The total cross-section is obtained using Equation \eqref{solid angle} and \eqref{rayleigh cross section},

\begin{equation}
\label{total cross-section}
\sigma_s = 4\pi k^4 a^6 \left[\left(\frac{G-G_0}{3G}\right)^2 +\frac{1}{3}\left(\frac{\rho-\rho_0}{2\rho + \rho_0}\right)^2\right].
\end{equation}
In these equations $k$ is the wavenumber, $a$ the radius of the scatterer, and the zero subscript refer to properties of the surrounding medium. The angle $\theta$ is the angle between the incident wave and the scattered wave, i.e. $\theta = 180\deg$ is the direction of backscatterering. Although these equations represent a coarse approximation, it demonstrates why gas bubbles are excellent contrast agents. The density term in Equation \eqref{total cross-section} is limited to $\nicefrac{1}{3}$, while the bulk modulus term has no upper limit as $G$ gets small compared to $G_0$. Thus, it is the compressibility and not the acoustic impedance which is the main cause to the scattering off a gas bubble. 

It is also important to keep in mind that it is the backscattering and not the total scattering which determines the signal at the transducer, and Equation \eqref{rayleigh cross section} give therefore a more correct image than Equation \eqref{total cross-section}. 
%Include table from andys Ultrasound paper?
%Include figures os differntial cross-sections?


\subsubsection{Resolution and depth of view}
The ultrasound waves used in medical imaging are emitted as short pulses, where the pulse length determines the longitudinal resolution. It is not possible to distinguish two points in the longitudinal direction separated by a distance shorter than half the pulse length. A short pulse is therefore desirable in order to produce good longitudinal resolution. The theoretical minimum pulse length is one wavelength, although this is difficult to achieve in practice, and a few wavelengths is a more realistic minimum. A short pulse will contain a wider band of frequencies than a long pulse. 

The required depth of view will depend on how deep the tissue subject to the imaging is located, but there will always be a finite required depth penetration. The attenuation of ultrasound is proportional to the frequency, so a good depth of view implies a low frequency. Hence, there will always be a trade off between good longitudinal resolution and depth of view, and the diagnostic frequency will be chosen according to the patient and application. 

Lateral resolution is the minimum distance perpendicular to direction of propagation required to distinguish two objects. This is determined by the width of the beam, and may vary with the depth of view. It is common to focus the beam to obtain the best resolution at the depth of interest. Strong focusing will give very good resolution at a very limited depth range, while weak focusing give medium resolution through most of the image. Temporal resolution is determined by the frame rate, which is typically between 10 and 30 frames per second. 

\section{Tumor/cancer}
\subsection{Tumor growth and properties}

 A tumor is a mass of tissue with abnormal growth, and may either be benign or malignant. A benign tumor is localized with a  well-defined boundary and do usually not pose any health threat. A malignant tumor is what we know as cancer, and can invade adjacent tissue, perform metastasis and be life threatening. 

A cancer starts off from one abnormal cell, which proliferates through cell division resulting in uncontrolled growth. To maintain growth beyond a critical size of about \SI{1}{\milli\metre}\cite{king2006cancer}, new blood vessels are induced through angiogenesis to meet the need of nutrients and oxygen. 

The cell growth is regulated by two types of genes. Proto-oncogenes regulate normal cell proliferation, while the tumour suppressor genes control repair of cell damage, cell death and growth inhibition. Mutation or loss of any of these regulatory systems can cause cancer growth. 

The invasion of adjacent, normal tissue distinguish the malignant tumour from the benign, and this happens along along the pathways of least resistance, i.e. along vessels or fascia. This invasion is enhanced by increased amount of proteases outside the tumor boundary, which increase mobility of the cancerous cells. This also enhance the metastasis, where the cancer is spread along the lymphatic vessels, blood vessels or the peritoneal cavity to a new site.
 
An important feature which cause the possibility of localized drug delivery, is the structure of the cancer vasculature. This vasculature is developed through the angiogenesis, which is enhanced by Vascular endothelial growth factors(VEGFs). The VEGFs diffuse through the extracellular matrix(ECM) and connect to receptors on the inner surface of the vessel walls(Endothelial cells)\cite{Koumoutsakos2013}. This stimulate both the production of more endothelial cells and the construction of new vessels through the extracellular matrix\cite{Nishida2006}. This results in a structure which differ from normal vasculature. The tumour vasculature has increased vessel density and vessel size, a large amount of dead-ends and a disordered branching pattern.    

The abnormal level of endothelial cells leads to vascular walls which lack in coverage of perivascular cells and tight adherens junctions which stabilize the vessel. Hence, there will be large intracellular spaces in the vessel wall, and the vessel becomes leaky. This allow the cancer cells to enter the vasculature, enhance macromolecular transport through the vessel wall, and increase interstitial pressure within the tumour. This is known as the \textit{enhanced permeability and retention}(EPR) effect. The EPR effect leads to accumulation of macromolecules within the tumour, and enhance local delivery of cancer drugs.



\subsection{Cancer treatment}
Despite the massive amount of research on the field of cancer, all existing treatments suffer from side-effects and limited results. Most types of cancer are strongly related to lifestyle. Prevention is therefore the most important action in the battle against cancer. Another important action is screening, which can reveal cancer in an early stage. Early detection has shown to be decisive for the outcome of the cancer treatment\cite{king2006cancer}\cite{Jordan1986}.

The current treatments can be divided into chemotherapy, radiotherapy or surgery. Surgery aim to remove the entire tumour and, if possible, any metastases in regional lymphatics. Surgeries may be difficult to perform without damaging adjacent tissue. Radiotherapy is performed by radiating the tumour with high-energy X-rays to kill the malignant cells by causing fatal damage to their DNA. Some healthy tissue such as the lens of the end the spinal cord are very vulnerable to radiation, and can be damaged it exposed to a high radiation dose. Both of these treatments are best suited for not-metasized tumours.  

\subsection{Ultrasound mediated drug delivery}



\subsection{Contrast agents}
\label{contrast agents}
%SHell: Albumin, lipid, polymer, Nanoparticles??
%%%Ta med et avsnitt om forskjellige oscillasjoner til bobler. Kollaps, stabil osciallsjo, non-linear
%%Targeted microbubbles

Contrast agents are used to increase the image sensitivity and signal-to-noise ratio in medical imaging. In ultrasound imaging, this is accomplished by intravenous injection of a solution containing gas-filled microbubbles. Microdroplets are also used\cite{Soman2006}, but in much less extent than gas bubbles and is outside the scope of this thesis. Microbubbles are favourable because of the higher echogenicity\cite{Talu2008}.

The microbubbles have to fulfill several requirements to perform as a contrast agent. The contrast agent has to be delivered to the area of interest, and this set reguirements to lifetime and size. The diameter has to be smaller than \SI{8}{\micro\metre} to pass the pulmonary capillary\cite{Tickner1980}, which is the size limiting factor in the circulatory system. Strong backscattering of ultrasound is important. Absorption is an unwanted effect as it attenuates the ultrasound wave without contributing to the received signal. It is also important that the contrast agent is well tolerated by the body and is able to leave the circulatory system either by dissolving or by being phagocytosed by the kupfer cells in the liver\cite{Healey2012}.

The first contrast agents were made by saline, and was put to use by cardiologists in the 1960s for identification of mitral valve echoes. The saline was shaken before injection to create the microbubbles. Current available contrast agents have been able to fulfill the requirements stated, and consist of a gas enclosed in a suited shell. The shell has to be biocompatible and is made from fat, proteins or polymers. The advantage of a shell is increased lifetime and scattering of ultrasound. The size of the microbubbles is approximately equal to the size of red blood cells, i.e. (\SIrange{2}{6}{\micro\metre}).

The microbubbles have two important properties which cause large scattering. The first reason is the big difference in acoustic impedance between microbubbles and blood. The second property is the compressability of the gas inside the microbubble. The pressure fluctuations caused by the ultrasound forces the microbubble to expand during rarefaction and contract during compression. The microbubble will oscillate with the same frequency as the ultrasound source, and the scattering will be strongest at the resonance frequency of the microbubble. The resonant frequency is determined by the properties and the size of the shell.

The use of contrast agents has been limited to diagnostics, but these microbubbles possess properties suited therapeutic use. The microbubbles can serve as carriers for ultrasound mediated drug delivery \cite{Dijkmans2004}, see section ?????. 

\subsection{Phase-shift bubbles}
%Kanskje dette skal under metode???
The drug carrier used in this project is a two component particle composed of negatively charged gas microbubbles and positively charged droplets, known as Acoustic cluster therapy (ACT). Both the gas microbubble and the droplet have an initial size about \SIrange{2}{3}{\micro\metre}. The gas microbubble consist of a low solubility perfluorocarbon gas encapsulated in a negatively charged phospholipid membrane, e.g. Sonazoid\texttrademark. The drug is dissolved in a perfluorated oil phase and stabilized by a positively charged phospholipid membrane. When the bubbles and droplets are mixed, clusters of droplets and bubbles will form due to electrostatic attractive forces.


\begin{figure}[h]
  \centering
  \label{Fig:Sonazoid}
  \includegraphics[scale=0.8]{figurer\PS_compound.png}
  \caption{Illustration of phase-shift bubble, with the gas microbubble(left) and microdroplet(right).}
\end{figure}


When the clusters are exposed to ultrasound of standard medical frequency and intensity(??),the microbubble will oscillate and transfer energy to the droplet through mechanical interactions at the boundary. This initiate a fusion into a gas and liquid mixture, encapsulated by a mixed surfactant membrane. The fluid will vaporize and expand to a gas bubble of approximately \SI{30}{\micro\metre}. The enlarged gas bubble can block the capillary network and maintain the local concentration of the released drug. 

If we assume rapid thermal conduction from surrounding blood, the partial pressure of pf-MCP will be close to the vapour pressure at body temperature. This vapour pressure is lower than the local hydrostatic pressure, and the difference is initially equalized by the gas from the microbubble. An inward diffusion of $\mathrm{O_2, N_2, CO_2, H_2O and Ar}$ will exist simultaneously, and these gases will also contribute to the equalization of the hydrostatic pressure. The inward diffusion is driven by partial pressure gradients of the respective gases. 

The evaporation will not occur if the blood is under-saturated of the aforementioned gases. If the hydrostatic pressure inside the bubble is too large, there will be no pressure gradient to drive the inward diffusion. This is caused by too high surface tension or hydrostatic pressure in the surrounding blood, and this stop the evaporation. This initial evaporation occurs in a second or less\cite{Healey2013}. The inward diffusion may continue after the evaporation, until a maximum size is reached after approximately 20-30 seconds(Ref?).

Application of low MI and low frequency(\SIrange{0.1-2}{\mega\hertz} ultrasound will drive an oscillation of the large phase-shift bubbles and increase the permeability of the adjacent vasculature(REF?). This allow diffusion of the drug through the vessel walls to the cancer cells. The increased permeability will cease when the ultrasound is turned off leaving the drug trapped within the tumour.

A more mathematical description of the aforementioned evaporation is given now\cite{Healey2013}. We assume we can use the simplification that the gases are ideal gases, i.e. we can use the ideal gas law
\begin{equation}
\label{ideal gas law}
 PV = nRT. 
\end{equation}  
Hence, the volume of evaporated gas, $v_{pf}$, is a function of the initial volume and pressure in the oil droplet, i.e.

\begin{equation}
\label{gas volume}
V_g(V_{pf}, p_{pf}) = \frac{n_{pf}RT}{p_{pf}}=\frac{V_{pf}\rho_{pf}RT}{M_{pf}p_{pf}}.
\end{equation}

We assume the body temperature $T$ to be \SI{310}{\kelvin}. If also assume that both the gas and liquid bubble are spherical, we have the simple relation between diameter and volume, $V = \frac{\pi d}{6}$, and using this and Equation \eqref{gas volume}, we get an expression for the diameter of the gas bubble, 

\begin{equation}
\label{diameter}
d_g(p_{pf}, d_{pf}) = d_{pf}\sqrt[3]{\frac{\rho_{pf}Rt}{M_{pf}p_{pf}}}.
\end{equation}

From this equation we can get the size of the gas bubble after the initial evaporation. For an initial diameter of \SI{4}{\micro\metre} we get a diameter about \SI{23.4}{\micro\metre}, knowing that the vapour pressure of pf-MCP at body temperature is \SI{76}{\kilo\pascal}\cite{Healey2013}.
To include surface tension we use the Young-Laplace equation for a sphere,
\begin{equation}
\label{Young-Laplace}
\Delta p = \gamma\frac{4}{d},
\end{equation}

to get an expression for the pressure in the surrounding fluid, 

\begin{equation}
p_w = p_{partial} + p_{pf} - \gamma frac{4}{d_g(p_{pf}, d_{pf})}.
\end{equation}
Here $p_w$ is the total pressure in the surrounding fluid, while $p_{pf}$ is the partial pressure from the gases in the surrounding fluid. Combining equations above we get a cubic expression for the gas bubble diameter,  

\begin{equation}
\label{cubic}
(p_w-p_{partial})D_g^3 + 4\gammaD_g^2 - \frac{6v_{pf}\rho_{pf}RT}{\pi M_pf}.
\end{equation}

This equation has a real solution, and can be used to calculate an upper limit for the phase-shift gas bubble diameter. This is shown in Figure ???.
%Insert figures.

%Dynamic calcultions 
In addition to the static description above, we can derive an expression for the dynamic bubble growth. The following is a simplified model.

There exist a mechanical equilibrium(pressure) at the bubble boundary, and from the ideal gas law (Equation \eqref{ideal gas law}) we have that

\begin{equation}
\label{mec eq}
p_A + p_{pf} = \frac{2\gamma}{r} + p_{atm}+p_{blood}, 
\end{equation}
where
\begin{equation}
p_A + P_{pf}= (C_A+C_{pf})RT.
\end{equation}

Using both Fick's first law of diffusion and that a change in mass have to cause a flux through the boundary ($J = -\od{n}{t}$), we have that

\begin{equation}
\label{flux}
J_{pf} = -\od{}{t}\left(\frac{4\pi C_{pf}r^3}{3}\right) = 4\pi r(c_{pf}(r)-c_{pf}(\infty)),
\end{equation}
and a similar expression for $J_A$. Note that the diffusion flux $J$ is given in mol per second. We can assume that the concentration of pf-MCP goes to zero for far from the bubble, i.e. $ c_{pf}(\infty)=0$. We get two differential equations, 
\begin{equation}
\label{diff1}
-\od{}{t}(C_{pf}r^3) = 3rD_{pf}L_{pf}C_{pf},mathrm{ and } -\od{}{t}(C_Ar^3)=3rD_AL_A(C_A-\frac{p_{air}}{RT}. 
\end{equation}
Here $L$ is the concentration Ostwald coefficient describing the solubility of a gas, $L = \left(\frac{c}{C}\right)_{equilibrium}$\cite{Equilibria1984}. Lower-case $c_x$ is the concentration $x$ in the liquid phase, while upper-case $C_x$ is the concentration of $x$ in the vapour phase. Under saturation of air is incorporated in the term $\frac{p_{air}}{RT}$.

We rewrite the these equations with dimensionless variables to get
\begin{equation}
F + A = \mu \rho^2+(1+\vartheta)\rho^3,\quad \od{F}{\Gamma}=-\frac{3L_{pf}}{\rho^2}F\quad mathrm{and}\quad \od{A}{\Gamma}=-\frac{3\delta L_A}{\rho^2}(A-p_d\rho^3),
\end{equation}
with the dimensionless variables
\begin{multline}
\label{dim}
\mu=\frac{2\gamma}{p_{atm}r_0}, \quad \vartheta = \frac{p_{blood}}{p_{atm}}, \quad \rho = \frac{r}{r_0}, \quad \chi_A =\frac{C_ART}{p_{atm}},\\
\chi_{pf} = \frac{C_{pf}RT}{p_{atm}}, \quad \Gamma = \frac{D_{pf}}{r_0^2}t, \quad A = \chi_A\rho^3, \quad F = \chi_{pf}\rho^3, \quad and \quad p_d = \frac{p_{air}}{p_{atm}}.
\end{multline}

Combining equations we get a differential equation for $\rho$, 
\begin{equation}
\label{diff3}
\od{\rho}{\Gamma} = \frac{-3\delta L_A(A-p_d\rho^3)- 3L_{pf}(\mu\rho^2+(1+\vartheta)\rho^3-A)}{\rho^3(2\mu+3(1+\vartheta)^rho)}.
\end{equation}

These three differential equations can be solved using appropriate initial conditions. Defining the variable $X_{pf}$ to be the initial mole fraction of pf-MCP, we get the initial conditions

\begin{equation}
F(0) = X_{pf}(\mu +\vartheta +1),\quad A(0)=(1-X_{pf})(\mu+\vartheta+1)\quad
\mathrm{and}\quad \rho(0)=1.
\end{equation}

The growth of the bubble radius and volume is calculated from these differential equations and shown in Figure ???.


\subsection{Transducer}
??

\subsection{Image processing of B-mode images}
After the echoes have reached the transducer a signal is produced by making an image with the brightness at each pixel determined by the strength of the echo from that corresponding distance and direction. The first step in the image processing is to convert the signal from analogue to digital. The digital signal is less vulnerable to noise and distortion, and it enables further digital image processing. Then a linear amplifier apply the same amount of gain to the entire signal, to make the signal strong enough for further processing. Time-gain compensation is then applied to make echoes from similar interfaces equal, regardless of the depth of their origin. This is performed by increasing the gain with increasing depth of echo. The depth of the echo is identified by the arrival time at the transducer. The rate of attenuation of ultrasound with depth is determined by the frequency and tissue.

After amplification and time-gain compensation the dynamic range of the signal is about 60 dB. The dynamic range of a signal is defined as the ratio between the largest amplitude that can be recorded without causing distortion and the lowest amplitude that can be distinguished from noise. The dynamic range of a common screen is about 20 dB. The signal must therefore be compressed before it can be displayed. To compress the dynamic range from 60 to 20 dB, an amplifier with non-linear gain is applied. Low amplitudes are amplified more than high, and the dynamic range is therefore decreased. Compression allows weak echoes from scattering within tissue to be displayed together with strong echoes from tissue interfaces.

\subsubsection{RF and IQ data}
RF is short term for radio frequency data which is used in ultrasound as a description for unprocessed data. IQ is short term for in quadrature, and refers to a demodulation of the RF signal to reduce the amount of storage space without loss of information. IQ modulation converts the signal from the real to the imaginary space. The IQ signal is obtained using a IQ-demodulator to down-mix, low-pass filter and decimate the RF signal. The IQ signal can also be computed by through a Hilbert transform\cite{Kirkhorn1999}.

\subsubsection{Hilbert transform}
The Hilbert transform is a linear operator which acts on a signal $u(t)$ to derive an analytic signal. The Hilbert transform convert the signal from real to complex space by adding or subtracting 90 degrees. It is therefore also known as a phase-shift operator. An analytic signal has by definition only positive frequencies in its Fourier transform, and is related to the Hilbert transform through 

\begin{equation}
\tilde{x}(t) = x(t) + x_h(t),
\end{equation}

where $x(t)$ is the signal, $x_h(t)$ the Hilbert transform of the signal, and $\tilde{x}(t)$ the analytic signal. The Hilbert transform can be written as a convolution, 

\begin{equation}
x_h(t) = x(t)*\frac{1}{\pi t},
\end{equation}

which can be interpreted as a filtering operation with a quadrature filter which shifts all sinusoidal components by a phase shift of $\frac{\pi}{2}$. The envelope is the amplitude of the analytic signal, and a B-mode image is created from the envelope of the signal. 

\subsubsection{Downsampling}
Because it is the envelope that is used to create the B-mode images, further reduction in data size can be achieved by downsampling of the RF signal. The RF signal is downsampled by a decimation factor $M$, by only recording every $M$th sample. 

The RF signal is a strictly bandlimited signal, limited by the bandwidth of the transducer. The envelope is thus also a bandlimited signal, with a finite maximum frequency. According to the Nyquist-Shannon sampling theorem, this signal can be sampled without aliasing or loss of information by a sampling rate twice the maximum frequency. Hence, the decimation factor, $M$, is determined so that

\begin{equation}
\label{deciamtion}
\frac{Fs_{RF}}{M} > 2f^{max}_{envelope},
\end{equation}

where $Fs_{RF}$ is the sampling frequency of the RF signal, and $f^{max}_{envelope}$ is the maximum frequency of the envelope. For a thorough explanation, see \cite{Crochiere1981}.



\subsection{Harmonic Imaging}

\subsection{Matlab}
The most important to write here is how the methods used in matlab work IN THEORY, not how they are implemented in MATLAB.


\subsubsection{Removing image artifacts}
The operation of removing movement artifacts are based on the Matlab toolbox Image Processing and the use of image registration. \textit{imregister} and \textit{imregconfig} are the first two functions that have been applied and tested. This is intensity based automatic registration. Control point registration may be another option.

%DETTE ER KANSKJE IKKE VIKTIG
%The process is initiated by making a \textit{metric} and an \textit{optimizer} object using the \textit{imregconfig} function. The \textit{metric} object measures the similarity of the two images. The \textit{optimizer} contains the optimization parameters such as maximum number of iterations, initial step length, optimization algorithm etc. Which optimization algorithm and how the image similarity is measured can be chosen in the \textit{imregconfig} function. The options for optimization algorithm are either a regular step gradient or a one-plus-one evolutionary method. For the metric object the similarity can be measured either by a mean square error approach or by making a mutual information metric. The mutual information metric maximizes the number of pixel with the same relative pixel value, and is best suited for images with different brightness ranges.[REF MATLAB]

\subsection{Speckle}
Speckle is a random, deterministic speckle pattern present in all types of coherent imaging, thus also in ultrasound images. The speckle is formed by scatterers smaller than the resolution of the imaging system, and the shape and size of the speckle pattern is determined by the dimensions of the imaging system and the structure of the imaged tissue.

The speckle is an interference phenomenon created by coherent waves with different phase and amplitude added together. If several echo waves arrive at the same piezoelectric element within a time span shorter than the emitted pulse, the piezoelectric element will not be able to distinguish the waves, and their impact will be added. 

\subsection{Image registration}
Image registration is the process where one image is spatially aligned to a reference image. The image to be aligned is called the moving image, while the reference image is called the fixed image. Image registration  is an important part of image processing and can both be used to remove motion artifacts or to fuse images of the same object, captured with different image modalities or from different directions. 

Image registration can initially be divided into extrinsic and intrinsic methods. Extrinsic methods are based on foreign objects placed into the scene before the image is captured. This has the advantage of simple, feature-based registration, but the preplacement and removal of these objects may not be trivial. 

Intrinsic methods can be divided into feature and intensity based registration. Features can either be easily recognizable points identified by the user, or structures which can be extracted from the image by image segmentation. These methods are mostly used in rigid transformations, and have the advantage of being simple computations once the features are determined. One drawback is that the registration often is limited by the reliability of the segmentation or identification of the features. Although these methods are applicable to both multi- and monomodal registration, and to different body parts, their use have in general been limited to neuroimaging and orthopedic imaging\cite{Maintz1998}.

Intensity based registration differs from the other methods by using the intensity pixel values directly to compare the fixed and moving image. To compare the images a suited similarity measure is used, see section\ref{subsec:similarity}. Using different similarity measures, this method is suitable for both multi- and monomodal registration. The image registration is then performed using an optimization routine to find the spatial translation of the moving image which minimizes the chosen similarity measure. Choosing the right similarity measure and optimization scheme is essential to get a satisfying result. For a full review of this topic, see \cite{Maintz1998}.

\subsubsection{Basic theory of image registration}
\cite{Mainstream}
%Should non-parametric transformations be mentioned?

%Transformation of an image is the basis for image registration, and can be described as a function $y$ mapping the image coordinates from $\Real_d \arrow \Real_d$ using a linear combination of basis functions and coefficients.

\subsubsection{Image transformations}

Transformation of an image is the basis for image registration, and can be described as a mapping of a coordinate vector $\vec{x}$ from the space $X$ to a new coordinate vector $\vec{y}$ in the space $Y$. The transformation is performed by a transformation matrix $A$, i.e. $\vec{y} = A\vec{x}$.

In 2D a rigid transformation can be written as 

\begin{equation}
	\label{rigid}
	\begin{pmatrix}
		y_1 \\
		y_2 \\
		1 
	\end{pmatrix}
	=
	\begin{pmatrix}
		R_{11} & R_{12} & T_1\\
		R_{21} & R_{22} & T_2\\		
		0 & 0 & 1
	\end{pmatrix}
	\begin{pmatrix}
		x_1\\
		x_2\\
		1
	\end{pmatrix},
\end{equation}
where $R_{ij}$ are elements in the rotation matrix 

\begin{equation}
	R = 
	\begin{pmatrix}
	\cos \theta & -\sin \theta\\
	\sin \theta & \cos \theta
	\end{pmatrix}.
\end{equation}
The rotation matrix rotates the coordinates an angle $\theta$ around the origo. The matrix elements $T_{ij}$ determines the translation of the coordinates. An affine translation is described by the matrix 
\begin{equation}
\begin{pmatrix}
 a_{11}&a_{12}&a_{13}\\
 a
 
\end{pmatrix}
\end{equation} This enables shear and scaling of the image.

If we apply a transformation matrix to an image, we get the new pixel coordinates of transformed image, but these points will not be on the grid coordinates of the image. For that reason, an interpolation scheme is applied to the transformed image coordinates to get the new pixel values at the grid coordinates. A suitable interpolation scheme must be chosen according to the given problem, but the most common are described in section ??????

Image transformation can be divided into linear and non-linear transformation. For a linear transformation the same transformation matrix is applied to the whole image, whereas this is not the case for a non-linear transformation. Linear transformation is computationally faster and simpler, and less affected by noise. On the other hand, non-linear transformations can correct for local deformations out of reach for the linear transformation. 

The difficult part of image registration is not to apply the transformation, but to obtain the right transformation matrix. The simplest case is the point or feature based method, where easily recognized feature are localized in both the fixed and moving image, either by interaction from the user, or by using a feature detection algorithm. In the case of an affine transformation, six pair of corresponding coordinates are needed to solve the set of linear equations to obtain the the six unknown elements in the transformation matrix. Usually, more points are obtained, and the transformation matrix is calculated using a least-squares approach. 

\subsubsection{Similarity measure}
\label{subsec:similarity}
There are several ways of measuring the similarity between two images, where different approaches enhance different image properties, and are suitable for different problems. The choice of similarity measure will determine the minimum and the rate of convergence for the optimization scheme.

When the images to compare are from the same modality, they will be in the same intensity range. They will only differ because of noise, geometric transformation and changes in imaged object. Common similarity measures are then the sum of squared differences (SSD), the sum of absolute differences or the cross correlation. If the changes in the imaged object is sufficiently small, and we assume the noise to be Gaussian, it is shown in \cite{Viola1997} that SSD give the optimal result.
For two images $A$ and $B$ the SSD is given as
\begin{equation}
\label{SSD}
\mathrm{SSD} = \frac{1}{N}\sum_{i}^N \abs{A_i -B_i}^2, \forall i \in A \cap B,   
\end{equation}

where $i$ is an image pixel. 

In multimodal image registration, the images have neither similar intensities or even a linear relationship between the intensities. For this type of problems, mutual information is the most common similarity measure. Mutual information is a measure of the statistical dependence of the two images, and the alignment is optimal the moving image contains the maximal amount of information about the fixed image. For a detailed review of mutual information in medical multimodal imaging, see \cite{563664}.  

\subsection{Regular step gradient descent}
An optimization scheme determines the optimal alignment by optimizing the chosen similarity measure. The optimization scheme is usually chosen through an empirical approach, where computational demand, reliability and stability are important factors. 

The gradient descent method is a first-order algorithm which finds the local minimum of a multivarible, differentiable function $F(x)$. From a given initial state $x_k$, the optimizer moves a distance $\gamma$ in the direction opposite to the gradient, i.e.

\begin{equation}
\label{gradient descent}
x_{k+1} = x_k - \gamma \Delta F(x_k).
\end{equation}

This method suffers from the reliability of the step distance $\gamma$. Too long or short step will give a slow, or no convergence. The \textit{regular step gradient descent} is a variation where the step length is halved every time there is a significant change in the direction of the gradient. The optimization terminates after reaching a the minimum, at a minimum step length, or after a maximum number of iterations.

To speed up the image registration, a pyramidal method can be applied together with the gradient descent. A smoothing filter is applied to the images, before they are decimated by a factor 2. This is performed for a given number of pyramid levels, resulting in a set of images with decreasing size. The scheme starts by optimizing the translation for the smallest image, and the optimal translation is used as an initial translation in the next pyramid level. In addition the increased speed, there is also less chance of getting stuck in a local minimum due to the smoothing which is applied before each decimation.
 








