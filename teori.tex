%Teori.tex
\section{Theory}
\subsection{Ultrasound theory}
Ultrasound is sound waves with frequency above \SI{20}{\kilo\hertz}, which is the upper limit of audible sound. For the purpose of medical imaging, frequencies between \SI{1}{\mega\hertz} and \SI{18}{\mega\hertz} are common. The ultrasound is generated by a transducer, and as the wave travels through the body, echoes are generated by partial reflection at every boundary. The amount of reflection depends on the relative change in acoustic impedance at the boundary. The echo is recorded by the transducer, and it is then displayed in the image according its spatial origin. The speed of sound is approximately \SI{1540}{\metre\per\second} for all soft body tissue, and it is thus possible to calculate the origin by measuring the time of travel of the echo. 

\subsubsection{Imaging modalities}
Ultrasound images of can be captured using several different modalities to enhance different properties of the tissue. The simplest modality is the amplitude-mode(A-mode), where a single element transducer scans is used to generate echoes along one line, and the received echoes are plotted as a function of depth. Brightness-mode(B-mode) use an array of transducers to generate 2D map of a slice through the body, where the image brightness is proportional to the echo originated from the corresponding location. Motion mode (M-mode) is generated from a sequence of A- or B-mode images to image tissue motion. Doppler imaging is another large field of imaging modes, where the Doppler effect is utilized to image the blood flow. This can used to measure the velocity, direction and total blood flow. Non-linear imaging is another field of imaging modes used to enhance the visibility of contrast agents. This is described in more detail in Section \ref{sec:contrast img}.

\subsubsection{Ultrasound wave propagation}
Sound waves are pressure waves, and the pressure fluctuations cause temporal displacement of the medium in which the wave is traveling. For most imaging purposes the displacement is along the direction of travel, this is know as longitudinal waves. Solids can support transverse sound waves, but that is outside the scope of this thesis.  The wavelength , $\lambda$, is determined by the frequency of the source and the phase velocity in the medium, $c$, i.e. $\lambda= \frac{c}{f}$. The phase velocity $c$ is given by

\begin{equation}
\label{phace velocity}
c = \sqrt{\frac{1}{\rho \kappa}},
\end{equation}

where $\rho$ and $\kappa$ are the tissue density and compressibility, respectively. For soft human tissue the phase velocity is about \SI{1540}{\metre\per\second}.%, while it is about \SI{4000}{\metre\per\second} for bone.
The compressibility is a measure of the relative change in volume from change in pressure, that is $\kappa = -\frac{1}{V}\frac{\partial V}{\partial p}$. Here $V$ is volume and $p$ pressure. 

The propagation of a sound wave traveling in the x-direction can in a fluid be described by the wave equation, i.e.
\begin{equation}
\label{wave equation}
\frac{\partial^2W}{\partial x^2} = \frac{\rho_0}{G}\frac{\partial^2W}{\partial t^2}.
\end{equation}

Here $W$ is the particle displacement, $\rho_0$ the density of the medium and $G$ the bulk modulus. The bulk modulus is the reciprocal of the compressibility, and is a measure of the volume stiffness. A general solution to this equation is 
\begin{equation}
\label{particle displacement}
W = W_0 \exp^{i(kx - \omega t)},
\end{equation}

where $\omega$ is the angular frequency, $k = \frac{\omega}{c}$ the wave number, and $c$ the phase velocity as given in Equation \eqref{phace velocity}, with $\kappa$ substituted by $\frac{1}{G}$. The pressure variations is then given by particle velocity $u_x = \frac{\partial W}{\partial t}$ as 

\begin{equation}
\label{pressure wave}
p_z = \rho_0 c u_x.
\end{equation}

It is important to emphasize the difference between the phase velocity and the particle velocity. The phase velocity is the velocity of energy carried through the medium, while the particle velocity is the velocity of the local displacement of particles.

The acoustic impedance $Z$ of the medium is defined as the ratio of the pressure to the particle velocity,
\begin{equation}
\label{acoustic impedance}
 Z = \frac{p_x}{u_x} = \rho c.
\end{equation}
   %%%Sjekk fortegn?????????????????

 
\subsubsection{Reflection}
Reflection provide the basis for ultrasound imaging, and occurs when the wave encounter a planar surface with a change in acoustic impedance. Across this surface both the pressure and particle velocity have to be continuous. From these boundary conditions 
%The acoustic impedance $z$ is given by  
%\begin{equation}
%z = \rho c.
%\end{equation}
the intensity coefficients of the reflected $r_i$ and transmitted $t_i$ wave can be given as \cite{wells1969physical}
\begin{equation}
\label{fresnel}
r_i = \left(\frac{z_2 \cos \theta_i - z_1 \cos \theta_t}{z_1 \cos \theta_t + z_2 \cos \theta_i}\right)^2
\end{equation}

\begin{equation}
\label{fresnel2}
t_i = \frac{4z_2 z_1 \cos^2 \theta_i}{(z_2 \cos \theta_i + z_1 \cos \theta_t)^2}.
\end{equation}

Here $z_1$ and $z_2$ are the acoustic impedance in medium 1 and 2, shown in Figure ?????. The angle of reflection $\theta_r$ is equal the angle of incidence $\theta_i$, while the angle of transmission $\theta_t$ is given by Snell's law\cite{blackstock2000fundamentals}, $ c_2 \sin \theta_i = c_1 \sin \theta_t$. 

\subsubsection{Absorption}
Loss of kinetic energy to heat from the propagating wave to the surrounding medium is known as absorption. Absorption occur continuously and reduce the amplitude of the wave. For linear propagation of a pressure wave, this can be described as 

\begin{equation}
p(x) = p(0)\exp^{-\alpha_A(\omega)x},
\end{equation} 

where $p(0)$ is the initial pressure amplitude, $alpha_A$ the absorption coefficient and $\omega$ the angular frequency.

For non-linear propagation the absorption depends on the local amplitude, and in the diagnostic intensity range the non-linear interaction is proportional to the square of the intensity\cite{:/content/asa/journal/jasa/97/3/10.1121/1.412091}. Non-linear propagation also affects the shape and frequency spectrum of the propagating wave, and can usually not be ignored for contrast agent applications \cite{Healey2012}. 

%\subsubsection{Non-linear imaging??}
 
\subsubsection{Scattering}
Scattering is reflection that occur when the size $d$ of the surface encountered is comparable or smaller than the wavelength. Scattering can arise from inhomogenities in compressibility or density. Scattering reflects the wave in a large range of directions, and the backscattered signal received at the transducer is therefore weak compared to reflected echoes. The magnitude and direction of the scattering depends on the size of the scatterer and increase strongly with the frequency.  

\begin{figure}[h]
  \centering
  \includegraphics[width=0.8\linewidth]{scattering2.png}
  \caption{Fig:Scattering}
\end{figure}
If we consider an incoming plane wave propagating in the direction $\hat{i}$, see Figure \ref{Fig:scattering}, the incident pressure, $p_i$, at the scatter located at $\textbf{r}_0$ is then

\begin{equation}
p_i(\textbf{r}_0, t) = p_0\exp^{i(\textbf{r}_0\textbf{k}_i-\omega t)}.
\end{equation}

If we only consider the far field the scattered wave, $p_s$, at the observer at $\textbf{r}$ is given by \cite{Healey2012}

\begin{equation}
p_s(\textbf{r}, t) = f(\hat{r},\hat{i})\frac{\exp^{ik_s(\textbf{r}-\textbf{r}_0}}{\abs{\textbf{r}-\textbf{r}_0}}p_i(\textbf{r}_0, t).
\end{equation}

The $f(\hat{r},\hat{i})$ is the scattering amplitude function. The scattered intensity is

\begin{equation}
I_s = \frac{1}{2}\frac{\abs{p_s}^2}{\rho c} =\frac{1}{2}\frac{\abs{p_i}^2}{\rho c}\frac{\abs{f(\hat{r},\hat{i})^2}}{\abs{\textbf{r}-\textbf{r}_0}^2} = I_i \frac{\abs{f(\hat{r},\hat{i})}^2}{\abs{\textbf{r}-\textbf{r}_0}^2},
\end{equation}

where $I_i$ is the incident intensity. The differential scattering cross-section is defined as $\sigma_d = |f(\hat{r},\hat{i})|^2$. The scattering cross section is the integral of the differential cross section over all solid angles, i.e.

\begin{equation}
\label{solid angle}
\sigma_s = \int_{4\pi}\sigma_d \mathrm{d}\Omega.
\end{equation}

The Rayleigh scattering model is the simplest model for scattering of small particles, i.e. particles with a diameter $d << \lambda$. This model do not take damping or resonance effects into account. If we again consider the plane wave, the differential scattering cross section is given by \cite{morse1986theoretical}

\begin{equation}
\label{rayleigh cross section}
\sigma_d = k^4a^6\abs{\frac{G-G_0}{3G}-\frac{\rho-\rho_0}{2\rho+\rho_0}\cos\theta}^2.
\end{equation} 

The total cross-section is obtained using Equation \eqref{solid angle} and \eqref{rayleigh cross section},

\begin{equation}
\label{total cross-section}
\sigma_s = 4\pi k^4 a^6 \left[\left(\frac{G-G_0}{3G}\right)^2 +\frac{1}{3}\left(\frac{\rho-\rho_0}{2\rho + \rho_0}\right)^2\right].
\end{equation}
In these equations $k$ is the wavenumber, $a$ the radius of the scatterer, and the zero subscript refer to properties of the surrounding medium. The angle $\theta$ is the angle between the incident wave and the scattered wave, i.e. $\theta = 180\deg$ is the direction of backscatterering. Although these equations represent a coarse approximation, it demonstrates why gas bubbles are excellent contrast agents. The density term in Equation \eqref{total cross-section} is limited to $\nicefrac{1}{3}$, while the bulk modulus term has no upper limit as $G$ gets small compared to $G_0$. Thus, it is the compressibility and not the acoustic impedance which is the main cause to the scattering off a gas bubble. This is shown in Figure

\begin{figure}[h]
  \centering
  \label{Fig:rayleigh}
  \includegraphics[width=0.8\linewidth]{rayleigh_scatter.png}
  \caption{Contribution to Rayleigh scattering cross section from compressibility and density\cite{Hoff2000}.}
\end{figure} 

It is important to keep in mind that it is the backscattering and not the total scattering which determines the received signal, and Equation \eqref{rayleigh cross section} give therefore a more correct image than Equation \eqref{total cross-section}. 
%Include table from andys Ultrasound paper?
%Include figures os differntial cross-sections?

\subsubsection{The bubble as a linear oscillator}
The following section follows the derivation of the bubble as a linear oscillator in \cite{Hoff2000}, which contains a full review of the subject acoustic properties of contrast agents. To include the effects of damping and resonance, the microbubble can be modeled as a harmonic oscillator. Comparing the bubble with a mass/spring system, Figure \ref{Fig:oscillator}, the gas pressure, surrounding liquid and radiation resistance corresponds to the spring, mass and dash-pot, respectively. The limitation for linear oscillations is that the radial displacement of the bubble wall is small compared to the bubble radii. 

\begin{figure}[h]
  \centering
  \label{Fig:oscillator}
  \includegraphics[width=0.8\linewidth]{oscillator.png}
  \caption{The bubble as a harmonic oscillator. Compared to the mass/spring system\cite{Hoff2000}.}
\end{figure} 

As the bubble oscillates both the gas inside and the liquid outside the bubble add inertia to the system. Due to the relative low density of the gas, this contribution can be neglected. The gas inside the bubble act against any volume change of the bubble, thus acting as the spring in the system. The damping of the system is caused by heat transport to the surroundings, radiation of sound and by the viscosity of the liquid. If we consider a bubble with a shell, viscous forces in the shell contributes to the damping. 

%The equation of motion is obtained from the forces acting on the bubble surface, 
%
%\begin{equation}
%\label{eq:motion}
%F_m + F_s + F_R = \int \int_S p_i(t) \dif S,
%\end{equation}
%where$p_i(t)$ is the driving acoustic pressure, and the forces are given as
%
%\begin{equation}
%\label{eq:forces}
%F_m = - (R\dot{\epsilon} + m\ddot{\epsilon}), \quad F_s = -s\epsilon \mathrm{ and } F_R = 
%\end{equation}
%%%Include this???

For this system the resonance frequency $f_0$ is given as \cite{Hoff2000}
\begin{equation}
\label{resonance}
f_0 = \frac{\omega}{2 \pi}= \frac{1}{2 \pi a} \sqrt{\frac{3\kappa p_0}{\rho}+ \frac{12 G_s d_s}{a}}.
\end{equation} 

Here $a$ is the bubble radius, $G_s$ and $d_s$ the shear modulus and thickness of the shell, $p_0$ the atmospheric pressure and $\kappa$ the polytropic exponent pf the gas. The polytropic exponent is equal the adiabatic constant $\gamma$ for if the oscillations are adiabatic, while it is one for isothermal conditions. This depends on the bubble radius and signal frequency\cite{Hoff2000}. The second term on the right-hand side of Equation \eqref{resonance} is the contribution from the shell to the bulk modulus of the system. 

The scattering cross section is 
\begin{equation}
\label{eq:cross section}
\sigma_S = 4\pi a^2 \frac{\Omega^4}{(1-\Omega^2)^2 + (\Omega \delta)^2}, 
\end{equation}

where $\Omega = \nicefrac{\omega}{\omega_0}$ and $\delta$ the damping constant of the system. 

The scattering cross section for air bubbles and Sonazoid\texttrademark are plotted in Figure \ref{Fig:cross_sections}. We see that the presence of a shell increase the resonance frequency and broadens the resonance peak\cite{Healey2012}.
\begin{figure}[h]
  \centering
  \label{Fig:cross_sections}
  \includegraphics[width=0.8\linewidth]{cross_sections.png}
  \caption{Left: Log-log plot of the scattering cross section $\sigma_S$ for air bubbles with diameter \num{1}, \num{3} and \SI{8}{\micro\meter}. Right: Corresponding plot of Sonazoid\texttrademark bubbles.}
\end{figure} 
 
%%Model limitations?
\subsubsection{Non-linear behaviour}
Til now we have only considered the linear behavior for both the wave propagation and the bubble scattering and oscillation. A brief review of non-linear wave propagation follows, before a section on the bubble as a non-linear oscillator. A full review of these subjects are found in \cite{Uck2002} and \cite{Hoff2000}.

When the amplitude of the acoustic wave exceeds about \SI{1}{\mega\pascal} non-linear propagation become noticeable\cite{Uck2002}. Non-linear effects can be divided into local and cumulative. Local effects are displacement of vibrating sources, and differences in the relationship between pressure and particle velocity. Local effects are regarded as negligible, except for oscillating microbubbles where there is a change the pressure/bubble radius relationship\cite{Uck2002}. 

Cumulative effects are caused by differences in the propagation speed at different locations in the wave. At the peak pressure the tissue will be compressed, increasing the speed of sound. In the region of rarefaction the propagation speed is decreased.  This cause distortion of the waveform which will develop with distance, see Figure \ref{non_lin_prop}. The compression peak will move in the direction of propagation, while the rarefaction peak move in the opposite direction. This will decrease the distance between the two peaks, til they are coincident and we get a discontinuity of the wave.  

\begin{figure}[h]
  \centering
  \label{Fig:non_lin_prop}
  \includegraphics[width=0.8\linewidth]{non_linear_prop.png}
  \caption{The measured focal waveform of a \SI{3}{\mega\hertz} Doppler pulse in water for low acoustic pressure (a) and a pulse where the pressure is increased by 24 dB. The distortion of the waveform is easily seen in b\cite{Uck2002}.}
\end{figure} 

The distortion of the waveform generates high frequency components in the pulse frequency spectrum. These high frequency components appear at multiples of the fundamental frequency $f_0$, and are called harmonic frequencies. This is seen in Figure \ref{Fig:harmonics}. As the wave propagates further the high frequencies are more attenuated, and the wave will eventually regain its shape with a reduced amplitude. 

\begin{figure}[h]
  \centering
  \label{Fig:harmonics}
  \includegraphics[width=0.8\linewidth]{harmonics.png}
  \caption{Development of harmonic frequencies as the amplitude of the source is increased by 10, 20 and 26 dB from a near-linear situation. Measured at the focus of a \SI{3.5}{\mega\hertz} wave\cite{Uck2002}.}
\end{figure} 


\subsubsection{The bubble as a non-linear oscillator}
The non-linear response from a microbubble is in general not negligible. It is actually the property of interest, when used as contrast agents in diagnostic imaging, see Section \ref{sec:contrast img}. A brief review of the non-linearity of bubble oscillations is given below. A full review is outside the scope of this thesis, and the interested reader is addressed to \cite{Hoff2000}. 

Compared to tissue, the non-linear response from microbubbles are large, and further increased by the coincidence of the resonance frequency being in the range of frequencies used in diagnostic imaging. The non-linear response from the contrast agent   Optison\texttrademark is seen in Figure \ref{Fig:bub_response}. The presence of harmonic peaks proves the non-linear response of the microbubble. 

\begin{figure}[h]
  \centering
  \label{Fig:bub_response}
  \includegraphics[width=0.8\linewidth]{non_lin_bubble_response.png}
  \caption{Spectrum of scattered signal from an Optison\texttrademark microbubble, exposed to a signal with a fundamental frequency of \SI{2}{\mega\hertz}. The other peaks are due to the non-linear response of the bubble\cite{Shi1999}.}
\end{figure}
The non-linear dynamics of a spherical bubble in a infinite, incompressible fluid can be described by the Rayleigh-Plesset equation,
\begin{equation}
\label{r-p}
\frac{p_{R_0}\left(\frac{R_0}{R}\right)^{3\gamma}-p_0 - p(t)}{\rho_l} = \frac{3\dot{R}^2}{2}+R\ddot{R},
\end{equation}
where $R = R(t)$ is the bubble radius as a function of time, and $\dot{R}$ and $\ddot{R}$ the velocity and acceleration of the bubble wall, respectively. A derivation of the Rayleigh-Plesset equation is presented in Appendix \ref{App:R-P}.
%FIX beskrivelse a ligning!!!!.

This is an ordinary differential equation which can be solved with initial conditions $R(0) = R_0$, and $\dot{R} = 0$\cite{Moss2014}. 
%IINSERT FIGURES from ANDY???

\subsubsection{Contrast agents}
\label{contrast agents}
%SHell: Albumin, lipid, polymer, Nanoparticles??
%%%Ta med et avsnitt om forskjellige oscillasjoner til bobler. Kollaps, stabil osciallsjo, non-linear
%%Targeted microbubbles

Contrast agents are used to increase the image sensitivity and signal-to-noise ratio in medical imaging. In ultrasound imaging, this is accomplished by intravenous injection of a solution containing gas-filled microbubbles. Microdroplets are also used\cite{Soman2006}, but in much less extent than gas bubbles and is outside the scope of this thesis. Microbubbles are favourable because of the higher echogenicity\cite{Talu2008}.

The microbubbles have to fulfill several requirements to perform as a contrast agent. The contrast agent has to be delivered to the area of interest, and this set reguirements to lifetime and size. The diameter has to be smaller than \SI{8}{\micro\metre} to pass the pulmonary capillary\cite{Tickner1980}, which is the size limiting factor in the circulatory system. Strong backscattering of ultrasound is important. Absorption is an unwanted effect as it attenuates the ultrasound wave without contributing to the received signal. It is also important that the contrast agent is well tolerated by the body and is able to leave the circulatory system either by dissolving or by being phagocytosed by the kupfer cells in the liver\cite{Healey2012}.

The first contrast agents were made by saline, and was put to use by cardiologists in the 1960s for identification of mitral valve echoes. The saline was shaken before injection to create the microbubbles. Current available contrast agents have been able to fulfill the requirements stated, and consist of a gas enclosed in a suited shell. The shell has to be biocompatible and is made from fat, proteins or polymers. The advantage of a shell is increased lifetime and scattering of ultrasound. The size of the microbubbles is approximately equal to the size of red blood cells, i.e. (\SIrange{2}{6}{\micro\metre}).

The microbubbles have two important properties which cause large scattering. The first reason is the big difference in acoustic impedance between microbubbles and blood. The second property is the compressability of the gas inside the microbubble. The pressure fluctuations caused by the ultrasound forces the microbubble to expand during rarefaction and contract during compression. The microbubble will oscillate with the same frequency as the ultrasound source, and the scattering will be strongest at the resonance frequency of the microbubble. The resonant frequency is determined by the properties and the size of the shell.

The use of contrast agents has been limited to diagnostics, but these microbubbles possess properties suited therapeutic use. The microbubbles can serve as drug carriers for ultrasound mediated drug delivery \cite{Dijkmans2004}, see Section \ref{sec:umdd}.

Sonazoid\texttrademark is a contrast agent which has overcome all requirements stated above, with a structure and size distribution as seen in Figure \ref{Fig:Sonazoid}. There is a core of perfluorobutane gas, with a \SI{4}{\nano\meter} thick lipid monolayer shell with shear modulus and viscosity equal \SI{50(3)}{\mega\pascal} and \SI{0.8(1)}{\newton\second\per\meter\squared}, respectively\cite{Hoff2000}. The density of the perfluorobutane gas core is \SI{0.0098}{\gram\per\centi\meter\squared}, while the thermal diffusivity is \SI{0.07}{\centi\meter\squared\per\second}\cite{Healey2012}. The shell is a membrane of hydrogenated egg phosphatidyl serine (HEPS)\cite{Sontum2008}.

\begin{figure}[h]
  \centering
  \label{Fig:Sonazoid}
  \includegraphics[width=0.8\linewidth]{sonazoid.png}
  \caption{Left: The structure of Sonazoid\texttrademark , i.e. perfluorobutane gas encapsulated in a lipid monolayer. Right: Size distribution of Sonazoid\texttrademark and red blood cells\cite{Healey2012}.}
\end{figure}

\subsubsection{Contrast enhanced imaging}
\label{sec:contrast img}
%The relationship between acoustic pressure and microbubble behavior is shown in Figure .???
Due to the non-linear behavior of the microbubbles in contrast agent, non-linear techniques are often applied to enhance the contrast-to-tissue signal ratio. Non-linear imaging techniques can divided into hi- and low-MI.  For high-MI images the acoustic pressure is large enough to destroy most of the microbubbles in the imaging plane, releasing free gas bubbles and crating a short flash of high contrast. In low-MI images (MI \SIrange{0.05}{0.1}) few of the bubbles are disrupted and the non-linear scattering properties are used to form images. Different low-MI techniques are described below.

Second harmonic imaging is based on a transducer with a bandwidth covering both the fundamental transmit frequency, and its second harmonic, see Figure \ref{Fig:Second harmonic}. Even at moderate pressure (\SIrange{0.1}{0.3}{\mega\pascal}) microbubbles generate harmonic frequencies, and by excluding the fundamental frequency from the received signal, only the non-linear signal is recorded, and this increases the contrast-to-tissue ratio. The required bandwidth of the transducer give limitations to the spatial resolution. 


\begin{figure}[h]
  \centering
  \label{Fig:Second harmonic}
  \includegraphics[width=0.8\linewidth]{second_harmonic.png}
  \caption{The transducer used in second harmonic imaging. The bandwidth cover both the fundamental frequency $f_0$ and the second harmonic $2f_0$\cite{Hoskins2010}.}
\end{figure}
 
Phase inversion is another non-linear mode used to image contrast agents. Two pulses are emitted from the transducer, where the second pulse is \ang{180} out of phase with the first pulse, see Figure \ref{Fig:phase inversion}. When the two received signals are added, the linear part sum to zero because of the linear response to the applied pressure. The microbubbles are the principal source of the non-linear part in the image, and they will therefore be emphasized by this technique.

Amplitude modulation is another technique used to enhance the contrast-to-tissue ratio. Two or three pulses are emitted with different amplitudes. The tissue will respond linearly to the amplitude, while the non-linear response from the microbubbles increase dramatically to the increased amplitude. The linear response can be removed by subtracting the received signals. A combination of the phase-inversion and the amplitude modulation is also possible. 

\begin{figure}[h]
  \centering
  \label{Fig:phase inversion}
  \includegraphics[width=0.8\linewidth]{phase_inversion.png}
  \caption{The two signal pulses used in phase-inversion are \ang{180} out of phase. The non-linear signal is obtained from the sum of the two received signals\cite{Hoskins2010}.}
\end{figure}

\subsubsection{Phase-shift bubbles}
%Kanskje dette skal under metode???
The drug carrier used in this project is a two component particle composed of negatively charged gas microbubbles and positively charged droplets, known as Acoustic cluster therapy (ACT). Both the gas microbubble and the droplet have an initial size about \SIrange{2}{3}{\micro\metre}. The gas microbubble consist of a low solubility perfluorocarbon gas encapsulated in a negatively charged phospholipid membrane, e.g. Sonazoid\texttrademark. The drug is dissolved in a perfluorated oil phase and stabilized by a positively charged phospholipid membrane. When the bubbles and droplets are mixed, clusters of droplets and bubbles will form due to electrostatic attractive forces.


\begin{figure}[h]
  \centering
  \label{Fig:Sonazoid}
  \includegraphics[width=0.8\linewidth]{PS_compound.png}
  \caption{Illustration of phase-shift bubble, with the gas microbubble(left) and microdroplet(right).}
\end{figure}


When the clusters are exposed to ultrasound of standard medical frequency(\SIrange{2}{15}{\mega\hertz}\cite{Hoskins2010}) and intensity,the microbubble will oscillate and transfer energy to the droplet through mechanical interactions at the boundary. This initiate a fusion into a gas and liquid mixture, encapsulated by a mixed surfactant membrane. The fluid will vaporize and expand to a gas bubble of approximately \SI{30}{\micro\metre}. The enlarged gas bubble can block the capillary network and maintain the local concentration of the released drug. 

If we assume rapid thermal conduction from surrounding blood, the partial pressure of pf-MCP will be close to the vapour pressure at body temperature. This vapour pressure is lower than the local hydrostatic pressure, and the difference is initially equalized by the gas from the microbubble. An inward diffusion of $\mathrm{O_2, N_2, CO_2, H_2O and Ar}$ will exist simultaneously, and these gases will also contribute to the equalization of the hydrostatic pressure. The inward diffusion is driven by partial pressure gradients of the respective gases. 

The evaporation will not occur if the blood is under-saturated of the aforementioned gases. If the hydrostatic pressure inside the bubble is too large, there will be no pressure gradient to drive the inward diffusion. This is caused by too high surface tension or hydrostatic pressure in the surrounding blood, and this stop the evaporation. This initial evaporation occurs in a second or less\cite{Healey2013}. The inward diffusion may continue after the evaporation, until a maximum size is reached after approximately 20-30 seconds(Ref?).

Application of low MI and low frequency(\SIrange{0.1}{2}{\mega\hertz} ultrasound will drive an oscillation of the large phase-shift bubbles and increase the permeability of the adjacent vasculature(REF?). This allow diffusion of the drug through the vessel walls to the cancer cells. The increased permeability will cease when the ultrasound is turned off leaving the drug trapped within the tumor.

A more mathematical description of the aforementioned evaporation is given now\cite{Healey2013}. We assume we can use the simplification that the gases are ideal gases, i.e. we can use the ideal gas law
\begin{equation}
\label{ideal gas law}
 PV = nRT. 
\end{equation}  
Hence, the volume of evaporated gas, $v_{pf}$, is a function of the initial volume and pressure in the oil droplet, i.e.

\begin{equation}
\label{gas volume}
V_g(V_{pf}, p_{pf}) = \frac{n_{pf}RT}{p_{pf}}=\frac{V_{pf}\rho_{pf}RT}{M_{pf}p_{pf}}.
\end{equation}

We assume the body temperature $T$ to be \SI{310}{\kelvin}. If also assume that both the gas and liquid bubble are spherical, we have the simple relation between diameter and volume, $V = \frac{\pi d}{6}$, and using this and Equation \eqref{gas volume}, we get an expression for the diameter of the gas bubble, 

\begin{equation}
\label{diameter}
d_g(p_{pf}, d_{pf}) = d_{pf}\sqrt[3]{\frac{\rho_{pf}Rt}{M_{pf}p_{pf}}}.
\end{equation}

From this equation we can get the size of the gas bubble after the initial evaporation. For an initial diameter of \SI{4}{\micro\metre} we get a diameter about \SI{23.4}{\micro\metre}, knowing that the vapour pressure of pf-MCP at body temperature is \SI{76}{\kilo\pascal}\cite{Healey2013}.
To include surface tension we use the Young-Laplace equation for a sphere,
\begin{equation}
\label{Young-Laplace}
\Delta p = \gamma\frac{4}{d},
\end{equation}

to get an expression for the pressure in the surrounding fluid, 

\begin{equation}
p_w = p_{partial} + p_{pf} - \gamma \frac{4}{d_g(p_{pf}\mathrm{, } d_{pf})}.
\end{equation}

Here $p_w$ is the total pressure in the surrounding fluid, while $p_{pf}$ is the partial pressure from the gases in the surrounding fluid. Combining equations above we get a cubic expression for the gas bubble diameter,  

\begin{equation}
\label{cubic}
(p_w-p_{partial})D_g^3 + 4\gamma D_g^2 - \frac{6v_{pf}\rho_{pf}RT}{\pi M_pf}.
\end{equation}

This equation has a real solution, and can be used to calculate an upper limit for the phase-shift gas bubble diameter. This is shown in Figure ???.
%Insert figures.

%Dynamic calcultions 
In addition to the static description above, we can derive an expression for the dynamic bubble growth. The following is a simplified model.

There exist a mechanical equilibrium(pressure) at the bubble boundary, and from the ideal gas law (Equation \eqref{ideal gas law}) we have that

\begin{equation}
\label{mec eq}
p_A + p_{pf} = \frac{2\gamma}{r} + p_{atm}+p_{blood}, 
\end{equation}
where
\begin{equation}
p_A + P_{pf}= (C_A+C_{pf})RT.
\end{equation}

Using both Fick's first law of diffusion and that a change in mass have to cause a flux through the boundary ($J = -\od{n}{t}$), we have that

\begin{equation}
\label{flux}
J_{pf} = -\od{}{t}\left(\frac{4\pi C_{pf}r^3}{3}\right) = 4\pi r(c_{pf}(r)-c_{pf}(\infty)),
\end{equation}
and a similar expression for $J_A$. Note that the diffusion flux $J$ is given in mol per second. We can assume that the concentration of pf-MCP goes to zero for far from the bubble, i.e. $ c_{pf}(\infty)=0$. We get two differential equations, 
\begin{equation}
\label{diff1}
-\od{}{t}(C_{pf}r^3) = 3rD_{pf}L_{pf}C_{pf}, \mathrm{ and } -\od{}{t}(C_Ar^3)=3rD_AL_A\left(C_A-\frac{p_{air}}{RT}\right). 
\end{equation}
Here $L$ is the concentration Ostwald coefficient describing the solubility of a gas, $L = \left(\frac{c}{C}\right)_{equilibrium}$\cite{Equilibria1984}. Lower-case $c_x$ is the concentration $x$ in the liquid phase, while upper-case $C_x$ is the concentration of $x$ in the vapour phase. Under saturation of air is incorporated in the term $\frac{p_{air}}{RT}$.

We rewrite the these equations with dimensionless variables to get
\begin{equation}
F + A = \mu \rho^2+(1+\vartheta)\rho^3,\quad \od{F}{\Gamma}=-\frac{3L_{pf}}{\rho^2}F\quad \mathrm{ and }\quad \od{A}{\Gamma}=-\frac{3\delta L_A}{\rho^2}(A-p_d\rho^3),
\end{equation}
with the dimensionless variables
\begin{multline}
\label{dim}
\mu=\frac{2\gamma}{p_{atm}r_0}, \quad \vartheta = \frac{p_{blood}}{p_{atm}}, \quad \rho = \frac{r}{r_0}, \quad \chi_A =\frac{C_ART}{p_{atm}},\\
\chi_{pf} = \frac{C_{pf}RT}{p_{atm}}, \quad \Gamma = \frac{D_{pf}}{r_0^2}t, \quad A = \chi_A\rho^3, \quad F = \chi_{pf}\rho^3, \quad \mathrm{ and } \quad p_d = \frac{p_{air}}{p_{atm}}.
\end{multline}

Combining equations we get a differential equation for $\rho$, 
\begin{equation}
\label{diff3}
\od{\rho}{\Gamma} = \frac{-3\delta L_A(A-p_d\rho^3)- 3L_{pf}(\mu\rho^2+(1+\vartheta)\rho^3-A)}{\rho^3(2\mu+3(1+\vartheta)^rho)}.
\end{equation}

These three differential equations can be solved using appropriate initial conditions. Defining the variable $X_{pf}$ to be the initial mole fraction of pf-MCP, we get the initial conditions

\begin{equation}
F(0) = X_{pf}(\mu +\vartheta +1),\quad A(0)=(1-X_{pf})(\mu+\vartheta+1)\quad
\mathrm{and}\quad \rho(0)=1.
\end{equation}

The growth of the bubble radius and volume is calculated from these differential equations and shown in Figure ???.

   
\subsubsection{Resolution and depth of view}
The ultrasound waves used in medical imaging are emitted as short pulses, where the pulse length determines the longitudinal resolution. It is not possible to distinguish two points in the longitudinal direction separated by a distance shorter than half the pulse length. A short pulse is therefore desirable in order to produce good longitudinal resolution. The theoretical minimum pulse length is one wavelength, although this is difficult to achieve in practice, and a few wavelengths is a more realistic minimum. A short pulse will contain a wider band of frequencies than a long pulse. 

The required depth of view will depend on how deep the tissue subject to the imaging is located, but there will always be a finite required depth penetration. The attenuation of ultrasound is proportional to the frequency, so a good depth of view implies a low frequency. Hence, there will always be a trade off between good longitudinal resolution and depth of view, and the diagnostic frequency will be chosen according to the patient and application. 

Lateral resolution is the minimum distance perpendicular to direction of propagation required to distinguish two objects. This is determined by the width of the beam, and may vary with the depth of view. It is common to focus the beam to obtain the best resolution at the depth of interest. Strong focusing will give very good resolution at a very limited depth range, while weak focusing give medium resolution through most of the image. Temporal resolution is determined by the frame rate, which is typically between 10 and 30 frames per second. 

\subsubsection{Speckle}
Speckle is a random, deterministic speckle pattern present in all types of coherent imaging, thus also in ultrasound images. The speckle is formed by scatterers smaller than the resolution of the imaging system, and the shape and size of the speckle pattern is determined by the dimensions of the imaging system and the structure of the imaged tissue.

The speckle is an interference phenomenon created by coherent waves with different phase and amplitude added together. If several echo waves arrive at the same piezoelectric element within a time span shorter than the emitted pulse, the piezoelectric element will not be able to distinguish the waves, and their impact will be added. 

\subsection{Tumor and ultrasound}
\subsubsection{Tumor structure}

 A tumor is a mass of tissue with abnormal growth, made up of malignant and non-malignant cells, lymph and blood vessels, and the extracellular matrix. A tumor can usually be characterized as benign or malignant, where a benign tumor is localized with a well-defined boundary and do usually not pose any health threat. A malignant tumor is what we know as cancer, and can invade adjacent tissue, perform metastasis and be life threatening. 

A cancer starts off from one abnormal cell, which proliferates through cell division resulting in uncontrolled growth. To maintain growth beyond a critical size of about \SI{1}{\milli\metre}\cite{king2006cancer}, new blood vessels are induced through angiogenesis to meet the need of nutrients and oxygen. 

The invasion of adjacent, normal tissue distinguish the malignant tumor from the benign, and this happens along along the pathways of least resistance, i.e. along vessels or fascia. This invasion is enhanced by increased amount of proteases outside the tumor boundary, which increase mobility of the cancerous cells. This also enhance the metastasis, where the cancer is spread along the lymphatic vessels, blood vessels or the peritoneal cavity to a new site.
 
An important feature which cause the possibility of localized drug delivery, is the structure of the cancer vasculature. This vasculature is developed through the angiogenesis, which is enhanced by Vascular endothelial growth factors(VEGFs). The VEGFs diffuse through the extracellular matrix(ECM) and connect to receptors on the inner surface of the vessel walls(Endothelial cells)\cite{Koumoutsakos2013}. This stimulate both the production of more endothelial cells and the construction of new vessels through the extracellular matrix\cite{Nishida2006}. This results in a structure which differ from normal vasculature. The tumor vasculature has increased vessel density and vessel size, a large amount of dead-ends and a disordered branching pattern.    

The abnormal level of endothelial cells leads to vascular walls which lack in coverage of perivascular cells and tight adherens junctions which stabilize the vessel. Hence, there will be large intracellular spaces in the vessel wall, and the vessel becomes leaky. This allow the cancer cells to enter the vasculature, enhance macromolecular transport through the vessel wall, and increase interstitial pressure within the tumor. This is known as the \textit{enhanced permeability and retention}(EPR) effect. The EPR effect leads to accumulation of macromolecules within the tumor, and enhance local delivery of cancer drugs.



\subsubsection{Tumor imaging}
Imaging of tumors is important in diagnosis and early detection of cancer as it allows for non-invasive differentiation of benign and malignant tissue. It is possible to use B-mode images to distinguish on behalf of shape and texture, but these properties varies between different types of cancer For prostate cancer about half of the tumors could be identified in a B-mode image due to reduced echotexture and an oblong shape\cite{Halpern2006}. 

More advanced imaging such as Doppler or contrast enhanced imaging can image the tumor blood flow, and make it possible to distinguish benign and malignant tumor from the blood flow pattern. For thyroid cancer, benign tumors have a hilar flow pattern, while malignant tumors have a peripheral pattern with short branches\cite{Go2003}. Malignant tumors have also higher microvessel density, and it shown that there is a clear correlation between microvessel density and metastasis\cite{Rifkin1990}. Contrast agent microbubbles provides the possibility of visualizing microvessels with diameter less than the resolution of the imaging system. In Figure \ref{Fig:prostate cancer} prostate cancer is imaged using B-mode(A) and harmonic non-linear mode(B).

\begin{figure}[h]
  \centering
  \label{Fig:prostate cancer}
  \includegraphics[width=0.8\linewidth]{prostate cancer.png}
  \caption{Image of malignant prostate cancer(arrows)\cite{Halpern2006}. A: The tumor is seen as a hypoechoic area in B-mode. B: Harmonic imaging of contrast agent enhance the visibility of the tumor.}
\end{figure}

The extracellular matrix found in tumors is unusually stiff, and the solid stress applied to the vasculature is large enough to  squeeze some blood vessels shut. This prevent drug delivery and can cause hypoxia within tumor regions. Hypoxia does not lead to cell death, but increase the production of proteins which prevents tumor-fighting immune cells from functioning\cite{Jain2014}. By imaging the tumor vasculature using contrast agents, it is possible to see these oxygen depleted areas. This help predicting the outcome of cancer treatment. 
%the following section is maybe irrelevant
%\subsection{Cancer}
%The cell growth is regulated by two types of genes. Proto-oncogenes regulate normal cell proliferation, while the tumor suppressor genes control repair of cell damage, cell death and growth inhibition. Mutation or loss of any of these regulatory systems can cause cancer growth. 


\subsubsection{Cancer treatment}
Despite the massive amount of research on the field of cancer, all existing treatments suffer from side-effects and limited results. Most types of cancer are strongly related to lifestyle. Prevention is therefore the most important action in the battle against cancer. Another important action is screening, which can reveal cancer in an early stage. Early detection has shown to be decisive for the outcome of the cancer treatment\cite{king2006cancer}\cite{Jordan1986}.

Regardless of method, a treatment is successful if all cancerous cell are corrupted. This should be accomplished with the least possible damage to healthy tissue. Different treatments may perform best, depending on type of cancer, location of tumor and the stage of the cancer. The current treatments can be divided into chemotherapy, radiotherapy or surgery.  

Surgery aim to remove the entire tumor and, if possible, any metastases in regional lymphatics. Surgeries may be difficult to perform without damaging adjacent tissue. Radiotherapy is performed by radiating the tumor with high-energy X-rays to kill the malignant cells by causing fatal damage to their DNA. Some healthy tissue such as the lens at end of the spinal cord are very vulnerable to radiation, and can be damaged it exposed to a high radiation dose. Both of these treatments are best suited for not-metasized tumors. 

Chemotherapy use cytotoxic or cytostatic drugs to kill malignant cells or prevent further growth. The drugs are distributed through the circulatory system, and only a small fraction of the dose reach the malignant cells. The rest of the dose cause dangerous side effects to healthy tissue\cite{doi:10.1056/NEJM200106283442607}. These side effects limits the dose to a low level. This is described by a very low therapeutic index, which is the ratio between the maximum tolerated dose, and the minimum dose required for any therapeutic effect. 
 
\subsubsection{Localized drug delivery}
Increased targeting of the chemotherapeutic drugs enables the delivery more drug to the malignant cells without increase in the total dose.  The increased leakiness of the tumor vasculature and the over-expression of specific receptors, are two of the characteristic properties of tumor tissue which provide possibilities for targeted delivery. Recent research has enabled drug carriers on nanoscale which utilize these possibilities\cite{Jafari}. The research in this field can be divided into passive, active and triggered targeting. 


Passive targeting relies on the accumulation of drug in cancerous tissue due to the EPR effect. The drug is loaded into drug carriers which are only able to penetrate the endothelial layer if the EPR efeect is present\cite{Andresen2010}. The carriers are designed to remain in the circulatory system for a long time to provide sufficient accumulation in the tumor. These carriers are of a size \SIrange{10}{500}{\nano\meter}, although the lower cut off size varies\cite{Hofmann}. This targeting is limited by the vascularity and leakiness of the tumor. The increased hydrostatic pressure present in tumors can also reduce the accumulation\cite{Bae2009}.  

Active targeting is carried out by drug carriers where the surface is capable of recognition and binding to a target site in the tumor vasculature. This is shown in Figure ?. Triggered targeting use drug carries sensitive to exposure of ultrasound or to the changes in pH or enzymes which occur in cancerous tissue. Ultrasound mediated drug delivery is addressed below.

\subsubsection{Ultrasound mediated drug delivery}
\label{sec:umdd}
Ultrasound is an attractive trigger for targeted drug delivery as it is non-invasive, generally safe and well characterized. It is proved that ultrasound enhance the cell membrane permeability, in particular if microbubbles are present\cite{VanWamel2006a}. This is known as sonoporation. The proposed model is that the microbubbles enhance the EPR effect because of the oscillation initiated by the ultrasound, see Figure \ref{Fig:oscillating_bubble}. The oscillation moves the cell membrane and create hydrophilic pores which enables transport of fluid or macromulecules through the membrane\cite{VanWamel2006a}. Ultrasound can also increase the reach of the drug after leaving the vasculature\cite{Eggen2013}.

\begin{figure}[h]
  \centering
  \label{Fig:oscillating_bubble}
  \includegraphics[width=0.8\linewidth]{oscillating_bubble.png}
  \caption{The oscillation moves the cell membrane and create hydrophilic pores which enables transport of fluid or macromulecules through the membrane\cite{VanWamel2006a}.}
\end{figure}


There are several strategies for using sonoporation to enhance drug delivery. Small amounts of hydrophilic drug can be attached to the surface of the microbubble, or hydrophobic drug can be incorporated into the shell of the microbubble. The drug is then released as the microbubbles are disrupted by an ultrasound pulse\cite{Liu2006}. Drug has also been loaded into liposomes and administered together with microbubbles, but the effect is then very dependent of the simultaneous localization of the liposome and microbubble in the tumor vasculature. To ensure the co-localization the microbubble and the drug can be encapsulated together within a liposome membrane shell\cite{Ibsen2011}.

%Another strategy is the use of nanoparticles made from ......

%This effect can be utilized on drug loaded microbubbles to increase uptake. This is shown \textit{in vivo} for the drug liposomal doxorubicin in prostate cancer xenografts in mice\cite{Eggen2013}.
  


\subsection{Existing software/algorithms for image processing(counting)}
\label{existing algorithms}
A few algorithms handling quantification of stationary bubbles are published. In \cite{Rychak2006} the free bubbles were distinguished from the stuck bubbles by simply waiting for the circulating microbubbles to clear. The microbubbles are taken up in the liver or lungs, although this make take several minutes. The stuck microbubbles can then be segmented from the tissue signal by either using non-linear imaging, or by destroying the microbubbles with a high power ultrasound pulse. The signal left, can be subtracted from the prior signal to get the signal caused by microbubbles.

Two other methods are described in \cite{Zhao2007}. The first method utilizes a image-push-image sequence, where they first take one image before ultrasound radiation force is used to promote adhesion of the microbubbles. A second image is captured, and the the first image is subtracted to segment the contrast agent. The second method utilizes harmonic imaging and a high-pass filter to differentiate tissue and contrast agent. For both methods the signal from free flowing microbubbles is removed by low-pass interframe filtering. A low-pass filtering is also applied to distinguish free and stuck microbubbles in \cite{Needles2009}. Here, subharmonic imaging is used to segment microbubbles from the tissue. This method is successfully applied \textit{in vitro}.  
   
\subsection{Image processing}
\subsubsection{Transducer}
A transducer has the capability to transform applied electrical signals to pressure waves and vice versa. It is therefore responsible for both emitting ultrasound pulses and receiving echoes in an ultrasound apparatus. A good transducer perform this task with high conversion efficiency and without introduction of noise. 

The key element of the transducer is the piezo-electric element, which is a shaped piece of either a piezoelectric ceramic (lead zirconate titanate, PZT) or plastic (polyvinylidine difluoride, PVDF) coated with silver electrodes on the front- and backside. A voltage across the electrodes correspond to a proportional change of the thickness of the piezo-electric element.

The speed of sound, $c$, in a piezo-electric element is approximately \SI{4000}{\metre\per\second}. The fundamental resonance is at $\nicefrac{\lambda}{2}$, so the thickness, $T$, is given by the choice of the frequency $f$, i.e.
\begin{equation}
\label{thickness}
T = \frac{\lambda}{2}= \frac{c}{2f} = \frac{2}{f(\mathrm{Mhz})}.
\end{equation}  

Hence, the frequency range of a transducer i limited to a band around the fundamental resonance, and is determined by the thickness of the piezo-electric element. 

The front of the piezo-electric element is covered by a matching layer which increase the efficiency be reducing the difference in acoustic impedance between the element and the tissue. The back is covered by a backing medium which give mechanical support, provide mechanical damping. 

Today's transducers usually have an array of piezo-electric elements. The advantage is the possibility of beam steering, translation and focusing, and enables parallel processing which can reduce acquisition time, speckle and signal-to-noise ratio(SNR)\cite{Flower2012}.
   
\subsubsection{Digitalization, amplification and time-gain compensation}
After the echoes have reached the transducer a signal is produced by making an image with the brightness at each pixel determined by the strength of the echo from that corresponding distance and direction. The first step in the image processing is to convert the signal from analogue to digital. The digital signal is less vulnerable to noise and distortion, and it enables further digital image processing. Then a linear amplifier apply the same amount of gain to the entire signal, to make the signal strong enough for further processing. Time-gain compensation is then applied to make echoes from similar interfaces equal, regardless of the depth of their origin. This is performed by increasing the gain with increasing depth of echo. The depth of the echo is identified by the arrival time at the transducer. The rate of attenuation of ultrasound with depth is determined by the frequency and tissue.

After amplification and time-gain compensation the dynamic range of the signal is about 60 dB. The dynamic range of a signal is defined as the ratio between the largest amplitude that can be recorded without causing distortion and the lowest amplitude that can be distinguished from noise. The dynamic range of a common screen is about 20 dB. The signal must therefore be compressed before it can be displayed. To compress the dynamic range from 60 to 20 dB, an amplifier with non-linear gain is applied. Low amplitudes are amplified more than high, and the dynamic range is therefore decreased. Compression allows weak echoes from scattering within tissue to be displayed together with strong echoes from tissue interfaces.

\subsubsection{RF and IQ data}
RF is short term for radio frequency data which is used in ultrasound as a description for unprocessed data. IQ is short term for in quadrature, and refers to a demodulation of the RF signal to reduce the amount of storage space without loss of information. IQ modulation converts the signal from the real to the imaginary space. The IQ signal is obtained using a IQ-demodulator to down-mix, low-pass filter and decimate the RF signal. The IQ signal can be computed through a Hilbert transform\cite{Kirkhorn1999}.

\subsubsection{Hilbert transform}
The Hilbert transform is a linear operator which acts on a signal $u(t)$ to derive an analytic signal. The Hilbert transform convert the signal from real to complex space by adding or subtracting 90 degrees. It is therefore also known as a phase-shift operator. An analytic signal has by definition only positive frequencies in its Fourier transform, and is related to the Hilbert transform through 

\begin{equation}
\tilde{x}(t) = x(t) + x_h(t),
\end{equation}

where $x(t)$ is the signal, $x_h(t)$ the Hilbert transform of the signal, and $\tilde{x}(t)$ the analytic signal. The Hilbert transform can be written as a convolution, 

\begin{equation}
x_h(t) = x(t)*\frac{1}{\pi t},
\end{equation}

which can be interpreted as a filtering operation with a quadrature filter which shifts all sinusoidal components by a phase shift of $\frac{\pi}{2}$. The envelope is the amplitude of the analytic signal, and a B-mode image is created from the envelope of the signal. 

\subsubsection{Downsampling}
Because it is the envelope that is used to create the B-mode images, further reduction in data size can be achieved by downsampling of the RF signal. The RF signal is downsampled by a decimation factor $M$, by only recording every $M$th sample. 

The RF signal is a strictly bandlimited signal, limited by the bandwidth of the transducer. The envelope is thus also a bandlimited signal, with a finite maximum frequency. According to the Nyquist-Shannon sampling theorem, this signal can be sampled without aliasing or loss of information by a sampling rate twice the maximum frequency. Hence, the decimation factor, $M$, is determined so that

\begin{equation}
\label{deciamtion}
\frac{Fs_{RF}}{M} > 2f^{max}_{envelope},
\end{equation}

where $Fs_{RF}$ is the sampling frequency of the RF signal, and $f^{max}_{envelope}$ is the maximum frequency of the envelope. For a thorough explanation, see \cite{Crochiere1981}.


\subsubsection{Image registration}
Image registration is the process where one image is spatially aligned to a reference image. The image to be aligned is called the moving image, while the reference image is called the fixed image. Image registration  is an important part of image processing and can both be used to remove motion artifacts or to fuse images of the same object, captured with different image modalities or from different directions. 

Image registration can initially be divided into extrinsic and intrinsic methods. Extrinsic methods are based on foreign objects placed into the scene before the image is captured. This has the advantage of simple, feature-based registration, but the preplacement and removal of these objects may not be trivial. 

Intrinsic methods can be divided into feature and intensity based registration. Features can either be easily recognizable points identified by the user, or structures which can be extracted from the image by image segmentation. These methods are mostly used in rigid transformations, and have the advantage of being simple computations once the features are determined. One drawback is that the registration often is limited by the reliability of the segmentation or identification of the features. Although these methods are applicable to both multi- and monomodal registration, and to different body parts, their use have in general been limited to neuroimaging and orthopedic imaging\cite{Maintz1998}.

Intensity based registration differs from the other methods by using the intensity pixel values directly to compare the fixed and moving image. To compare the images a suited similarity measure is used, see section\ref{subsec:similarity}. Using different similarity measures, this method is suitable for both multi- and monomodal registration. The image registration is then performed using an optimization routine to find the spatial translation of the moving image which minimizes the chosen similarity measure. Choosing the right similarity measure and optimization scheme is essential to get a satisfying result. For a full review of this topic, see \cite{Maintz1998}.

%\subsubsection{Basic theory of image registration}
%\cite{Mainstream}
%%Should non-parametric transformations be mentioned?
%
%%Transformation of an image is the basis for image registration, and can be described as a function $y$ mapping the image coordinates from $\Real_d \arrow \Real_d$ using a linear combination of basis functions and coefficients.

\subsubsection{Image transformation}

Transformation of an image is the basis for image registration, and can be described as a mapping of a coordinate vector $\vec{x}$ from the space $X$ to a new coordinate vector $\vec{y}$ in the space $Y$. The transformation is performed by a transformation matrix $A$, i.e. $\vec{y} = A\vec{x}$.

In 2D a rigid transformation can be written as 

\begin{equation}
	\label{rigid}
	\begin{pmatrix}
		y_1 \\
		y_2 \\
		1 
	\end{pmatrix}
	=
	\begin{pmatrix}
		R_{11} & R_{12} & T_1\\
		R_{21} & R_{22} & T_2\\		
		0 & 0 & 1
	\end{pmatrix}
	\begin{pmatrix}
		x_1\\
		x_2\\
		1
	\end{pmatrix},
\end{equation}
where $R_{ij}$ are elements in the rotation matrix 

\begin{equation}
	R = 
	\begin{pmatrix}
	\cos \theta & -\sin \theta\\
	\sin \theta & \cos \theta
	\end{pmatrix}.
\end{equation}
The rotation matrix rotates the coordinates an angle $\theta$ around the origo. The matrix elements $T_{ij}$ determines the translation of the coordinates. An general affine translation is described by the matrix

\begin{equation}
\begin{pmatrix}
 a_{11}&a_{12}&a_{13}\\
 a_{21}&a_{22}&a_{23}\\
 0&0&1\\
 
\end{pmatrix}
\end{equation} 
This enables shear and scaling of the image.

If we apply a transformation matrix to an image, we get the new pixel coordinates of transformed image, but these points will not be on the grid coordinates of the image. For that reason, an interpolation scheme is applied to the transformed image coordinates to get the new pixel values at the grid coordinates. A suitable interpolation scheme must be chosen according to the given problem.

Image transformation can be divided into linear and non-linear transformation. For a linear transformation the same transformation matrix is applied to the whole image, whereas this is not the case for a non-linear transformation. Linear transformation is computationally faster and simpler, and less affected by noise. On the other hand, non-linear transformations can correct for local deformations out of reach for the linear transformation. 

The difficult part of image registration is not to apply the transformation, but to obtain the right transformation matrix. The simplest case is the point or feature based method, where easily recognized feature are localized in both the fixed and moving image, either by interaction from the user, or by using a feature detection algorithm. In the case of an affine transformation, six pair of corresponding coordinates are needed to solve the set of linear equations to obtain the the six unknown elements in the transformation matrix. Usually, more points are obtained, and the transformation matrix is calculated using a least-squares approach. 

\subsubsection{Similarity measure}
\label{subsec:similarity}
There are several ways of measuring the similarity between two images, where different approaches enhance different image properties, and are suitable for different problems. The choice of similarity measure will determine the minimum and the rate of convergence for the optimization scheme.

When the images to compare are from the same modality, they will be in the same intensity range. They will only differ because of noise, geometric transformation and changes in imaged object. Common similarity measures are then the sum of squared differences (SSD), the sum of absolute differences or the cross correlation. If the changes in the imaged object is sufficiently small, and we assume the noise to be Gaussian, it is shown in \cite{Viola1997} that SSD give the optimal result. For two images $A$ and $B$ the SSD is given as
\begin{equation}
\label{SSD}
\mathrm{SSD} = \sum_{i}^N \abs{A_i -B_i}^2, \forall i \in A \cap B,   
\end{equation}

where $i$ is an image pixel. A closely related similarity measure is the Mean square error, $MSE = \nicefrac{SSD}{N}$.

In multimodal image registration, the images have neither similar intensities or even a linear relationship between the intensities. For this type of problems, mutual information is the most common similarity measure. Mutual information is a measure of the statistical dependence of the two images, and the alignment is optimal the moving image contains the maximal amount of information about the fixed image. For a detailed review of mutual information in medical multimodal imaging, see \cite{563664}.  

\subsubsection{Regular step gradient descent}
An optimization scheme determines the optimal alignment by optimizing the chosen similarity measure. The optimization scheme is usually chosen through an empirical approach, where computational demand, reliability and stability are important factors. 

The gradient descent method is a first-order algorithm which finds the local minimum of a multivarible, differentiable function $F(x)$. From a given initial state $x_k$, the optimizer moves a distance $\gamma$ in the direction opposite to the gradient, i.e.

\begin{equation}
\label{gradient descent}
x_{k+1} = x_k - \gamma \Delta F(x_k).
\end{equation}

This method suffers from the reliability of the step distance $\gamma$. Too long or short step will give a slow, or no convergence. The \textit{regular step gradient descent} is a variation where the step length is halved every time there is a significant change in the direction of the gradient. The optimization terminates after reaching a the minimum, at a minimum step length, or after a maximum number of iterations.

To speed up the image registration, a pyramidal method can be applied together with the gradient descent. A smoothing filter is applied to the images, before they are decimated by a factor 2. This is performed for a given number of pyramid levels, resulting in a set of images with decreasing size. The scheme starts by optimizing the translation for the smallest image, and the optimal translation is used as an initial translation in the next pyramid level. In addition the increased speed, there is also less chance of getting stuck in a local minimum due to the smoothing which is applied before each decimation.
 
\subsubsection{Interpolation}
Interpolation is a mathematical method for obtaining new data points within the range of the current data points. Several different methods are common, all with a trade-off between performance and computational effort. For image interpolation, nearest neighbor, bilinear and bicubic are the most common. Nearest neighbor assign a value to the new data point equal the value of the nearest existing data point. The assigned value in bilinear interpolation is a linearly weighted sum of the nearest existing data points with respect to the distance to the new data point. 

For bicubic interpolation a cubic polynomial is calculated from the existing data to estimate the value at the new data point. This scheme is slower than nearest neighbor and bilinear, but the result is in general more smooth. 

\subsubsection{Background subtraction}
Background subtraction is a method for visualizing the contrast agent in the ultrasound images. A background image is created from a set of images recorded before presence of contrast agent. The background is constructed by taking the maximum value of the chosen set at each pixel. The contrast agent can then be segmented from the image by subtracting the background image. 

To ensure sufficient subtraction the background can be filtered before subtraction with a maximum filter. A maximum filter is a morphological filter which consider the neighborhood around a given pixel. The assigned value is equal the maximum value of the neighbors, and the size of the neighborhood is given by the size of the filter. In other words

\begin{equation}
B_{ij} = max(A_{kl}) \forall A_{kl} \in N,
\end{equation}
where $N$ is the neighborhood of $A_{ij}$, where $A$ and $B$ is the original and filtered image, respectively. 

%\subsubsection{Counting of phase-shift bubbles}
%Counting of individual bubbles in ultrasound images is a field of image processing with limited available literature and publications. One approach is described in \cite{Needles2009}, where microbubbles bound to vessel walls are differentiated from tissue and flowing microbubbles. Subharmonic imaging is used to separate tissue and microbubbles, before a low-pass inter-frame filter is applied to remove the free flowing microbubbles.

%\subsubsection{Temproral coherence filter}
%Temporal coherence is a measure of the correlation between the value of a pixel and the value of the same pixel at a later time. 
%F
%
%
%










