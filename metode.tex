%metode
%Materials
%Procedures
%Instrumentation
\section{Materials and methods}
\subsection{Image recording}
All ultrasound images have been recorded by Annemieke van Wamel and Andrew Healey prior to this study.
\subsubsection{The ACT\texttrademark{} clusters}
The ACT\texttrademark{} clusters are composed of \SI{3}{\micro\liter\per\milli\liter} microdroplets (pf-MCP) and \SI{8}{\micro\litre\per\milli\litre} (\SI{1.2e8}{\per\milli\litre}) of microbubbles (HEPS-Na stabilized PFB microbubbles[Sonazoid\texttrademark{}]). Two different doses were used:

\begin{enumerate}
	\item Low dose: \SI{50}{\micro\litre} of the mixture, diluted 1:4. contains \SI{0.72}{\micro\liter\per\milli\liter} oil droplets and \SI{2}{\micro\liter\per\milli\liter} microbubbles.
	\item High dose: \SI{50}{\micro\litre} of the mixture, neat, contains \SI{3}{\micro\liter\per\milli\liter} oil droplets and \SI{8}{\micro\liter\per\milli\liter} microbubbles.
\end{enumerate}  
 
The Sonazoid\texttrademark{} microbubbles are stored lyophilized, and reconstituted with sterile water to create a liquid solution. They are used both as a contrast agent, and as microbubbles together with microdroplets to compose the ACT\texttrademark{} clusters (Section \ref{sec:phase-shift bubbles}).  %Anyhting more here?

\subsubsection{Imaging setup}
%16Mhz
All ultrasound images evaluated during this work are imaged with the Vevo\texttrademark{} 2100 imaging system from Visual Sonics~\cite{Coulthard2009}. Two different imaging modes have been used, linear and non-linear contrast mode. Linear contrast mode was used to emphasize the ACT\texttrademark{} bubbles, while non-linear mode enhances the contrast from the Sonazoid\texttrademark{} microbubbles. The imaging settings are presented in Table \ref{tab:Vevo Ultrasound settings}.

\begin{table}[htb]
\caption{Settings used in the Vevo 2100 ultrasound apparatus.}
\label{tab:Vevo Ultrasound settings}
\begin{center}
\begin{tabular}{@{}l l l @{}}\toprule
& \multicolumn{2}{c}{Value} \\ \cmidrule(r){2-3}
Parameter & Linear contrast mode & Non-linear contrast mode\\
\midrule
Application & Cardiac & Cardiac\\
Preset & Contrast & Cardiac\\
Transmit:\\
Frequency & \SI{16}{\mega\hertz} & \SI{18}{\mega\hertz}\\
Power & 3\% & 10\%\\
Gate & & 6\\
Beamwidth & & Standard
Acquisition:\\
Gain & 10 dB & 10 dB\\
2D Gain & & 10 dB\\  
Frame rate & 10 fps & 10 fps\\
Depth & \SI{21.00}{\milli\meter} & \SI{21.00}{\milli\meter}\\
Width & \SI{23.04}{\milli\meter} & \SI{23.04}{\milli\meter}\\
Sensitivity & &1\\
Line density & Standard & High \\ 
Persistence & None & Off \\
Display:\\
Dynamic range &45 dB &40 dB \\
Display Map & MB1 & MB2\\
Brightness & 50 & 50\\
Contrast & 50 & 50 \\
  \bottomrule
\end{tabular}
\end{center}
\end{table}

For activation of the ACT\texttrademark{} clusters a transducer was placed in a water bath a fixed distance from the tumor. This transducer was either a V-scan or a Vivid MS5. The settings used are given in Table \ref{tab:V-scan vivid}.

 
\begin{table}[htb]
\caption{The settings used for the V-scan and the Vivid MS5 to activate the phase-shift bubbles.}
\label{tab:V-scan vivid}
\begin{center}
\begin{tabular}{@{}l l l @{}}\toprule
& \multicolumn{2}{c}{Value} \\ \cmidrule(r){2-3}
Parameter & V-scan & Vivid E9\\
\midrule
Preset & Cardiac & \\
Frequency & & \SI{2}{\mega\hertz}\\
Image distance & \SI{8}{\centi\meter} & \SI{2}{\centi\meter}\\
Focus depth & \SI{5}{\centi\meter} & \SI{1.5}{\centi\meter}\\
Frames per second & &Maximum\\
Angle & & \ang{45}\\
Mechanical index (MI) & \num{0.5} & \num{0.28} \\
  \bottomrule
\end{tabular}
\end{center}
\end{table}

The mice received anesthesia before injection of ACT\texttrademark{} or Sonazoid\texttrademark{}. The mice were placed on a rat handling table, with the left leg (location of tumor) lifted horizontally and fixed. Ultrasound gel and a water-bath bag was put on top of the tumor. The imaging and activation transducers were fixed inside the water-bath-bag (Figure \ref{Fig:setup}).

\begin{figure}[h]
  \centering
  \includegraphics[width=\linewidth]{experimental setup.png}
  \caption{Experimental setup for activation and imaging. The Vevo MS250 transducer (A) and the V-scan transducer (B) is placed within the water-bath. The tumor side (C) of the mouse faces the camera.}
  \label{Fig:setup}
\end{figure}

\subsubsection{High ultrasound bursts}
\label{sec:high US bursts}
In some of the ultrasound recordings, high power ultrasound were applied by the Vevo 2100 transducer. This was utilized because the high power ultrasound disrupts the Sonazoid\texttrademark{} microbubbles, while the large phase-shift bubbles are unaffected. This difference is utilized to distinguish the phase-shift bubbles from the Sonazid\texttrademark microbubbles. The high power ultrasound were set to the maximum duration in linear contrast and non-linear mode. That is \({<}\SI{0.1}{\second}\) and \SI{~2}{\second}, respectively~\cite{Coulthard2009}.


\subsubsection{Experimental protocol}
\label{sec protocols}
Four different combinations of ACT\texttrademark{} dose and transducer were used in this study:

\begin{enumerate}
  \item Animal 1 to 4. Vivid transducer and low dose.
  \item Animal 5 to 8. V-scan transducer and low dose.
  \item Animal 9 to 12. Vivid transducer and high dose.
  \item Animal 13 to 16. V-scan transducer and high dose.
\end{enumerate}
 
Sonazoid\texttrademark{} microbubbles were also injected alone as 1:4 dilution, \SI{50}{\micro\litre}, for assessment of vascularity. All injections were administrated as bolus. The general protocol applied is given below~\cite{Healey2014}. A detailed list, including all exceptions, is found in Appendix (\ref{raw counting}).
\FloatBarrier
\begin{enumerate}
	\item Imaging vasculature using Sonazoid\texttrademark{}.
		\begin{enumerate}
		\item Pre-injection images. Non-linear contrast mode.
		\item Sonazoid\texttrademark{} administration. Non-linear contrast mode.
		\item Post-administration images. In general 5 minutes after the injection. Non-linear contrast mode.
		\end{enumerate}
	\item Imaging and activation of ACT\texttrademark{}.
		\begin{enumerate}
		\item Pre-injection images. Non-linear contrast mode.
		\item Pre-injection images. Linear contrast mode.
		\item ACT\texttrademark{} administration. Linear contrast mode.
		\item Post-administration images. Linear contrast mode.
		\item Post-administration images. Non-linear contrast mode.
		\item Post-administration images. Linear contrast mode.
		\item Two bursts of high power ultrasound. Non-linear contrast mode.
		\item Two bursts of high power ultrasound. Linear contrast mode.
		\end{enumerate}
	\item Imaging vasculature using Sonazoid\texttrademark{}.
		\begin{enumerate}
		\item Pre-injection images. Non-linear contrast mode.
		\item Sonazoid\texttrademark{} administration. Non-linear contrast mode.
		\item Post-administration images. In general 5 minutes after the injection. Non-linear contrast mode.
		\end{enumerate}
\end{enumerate}  
 

\subsubsection{The animals}
Prostate adenocarcinoma cells (PC-3) were used in this research. The tumor cells were implanted in 40 female Balb/c mice at the age of 9-11 weeks. The tumor was implanted on the left hind limb, on the lateral side between the knee and the hip. The tumor cells were injected subcutaneously as a \SI{100}{\micro\meter} suspension containing \num{3e6} PC-3 cells.

\subsection{Image processing}
Image processing is performed on the acquired RF-data to enable image registration, background subtraction and counting of ACT\texttrademark{} microbubbles. The envelope of the RF-data is obtained from the absolute value of the IQ-modulated data. The RF-data are IQ-modulated through a Hilbert transform. A logarithmic compression is performed to reduce the dynamic range before image registration. The images are resized from $13568\times 256$ to $512\times 512$ through decimation and bicubic interpolation.  

\subsubsection{Image registration}
Motion correction is performed on all videos. All frames are aligned to a reference frame through an affine transformation. A regular step gradient descent optimization scheme has been utilized to determine the transformation matrix. The maximum number of iterations in the optimization scheme was set to 2000, using only one pyramid level. The reference frame was constructed from an average of the three first frames of the video used for background subtraction.

\subsubsection{Background subtraction}
Before background subtraction the data is linearized. For each processed video a background is computed from a set of frames. The set of frames is chosen individually to minimize motion artefacts through a heuristic approach. The background is filtered with a maximum filter of size $3\times 3$. The background is then subtracted from all frames to segment the signal caused by ACT\texttrademark{} or Sonazoid\texttrademark{} bubbles. Negative values after subtraction are set to 0. 

\subsubsection{Counting}
A region-of-interest (ROI) is defined prior to counting. The ROI is drawn to include most of the tumor, while avoiding skin and other healthy tissue. Only phase-shift bubbles within the ROI are counted. The counting of stuck phase-shift bubbles is based upon a temporal coherence filter to distinguish between stuck and free-flowing bubbles. A correlation matrix is constructed from the 40 previous frames, to form the base for this temporal coherence filter. A correlation matrix $d$ of two consecutive images, $A$ and $B$, is defined as
\begin{equation}
d_{ij} = 1-\frac{\abs{(A_{ij}-B_{ij})}}{A_{ij}+B_{ij}}\quad \forall i,j.
\end{equation}


%% INSERT FIGURE CORRELATION AND RUNNING AVERAGE

A running average of the correlation matrix is performed, and pixel indexes where the running average exceeds a temporal coherence threshold, $d_{min}$ are considered as stuck bubbles. The temporal coherence threshold is set to 0.85. This value is determined through a heuristic approach where the temporal coherence of manually identified bubbles is considered. A minimum intensity threshold is set to avoid counting of low-intensity noise. The minimum intensity threshold is set to 1000. It is important to emphasize that this algorithm counts the number of stuck phase-shift bubbles present, and not the total number of activated phase-shift bubbles.  

\subsection{Counting number of phase-shift bubbles in tumor}
For 16 animals, 125 data sets are processed in total, i.e. motion correction, background subtraction and automatic counting are performed. For each animal, one of the data sets images administration of ACT\texttrademark{} dilution. In these 16 videos, stuck phase-shift bubbles have been counted manually by Andrew Healey~\cite{Healey2014}. The manual counting is performed visually by careful identification of the phase-shift bubbles in the ultrasound videos. The results from manual and automatic counting are compared.

\subsubsection{Choosing representative number} 
For each data set, the maximal counted number density is the representative value when the automatically and manually results are compared. The first 20 frames are excluded because they may be considerably affected by the previous data set (Figure \ref{Fig:first_frames}). The reason for this is that the correlation matrix is continuously computed across consecutive data sets. The maximum value is chosen because it is closest to the total number of phase-shift bubbles activated throughout the video. This follows from counting algorithm which count number of present phase-shift bubbles. The number of bubbles present has to be lower or equal to the actual number of bubbles activated throughout the sequence.

\begin{figure}[h]
	\centering
	\includegraphics[width=\linewidth]{first_frames_corruption.png}
	\cprotect\caption{In the corresponding video we observe how the first 10-20 frames are affected by the correlation matrix from the previous video. The number of identified bubbles decreases quickly. The video is found at \path{F:\usb\avi\2014-05-03-09-56-48_count_and_color_1_to_100dilate_1_intensity_1000ct_0.85running_avg.avi}}
	\label{Fig:first_frames}
\end{figure}

\subsection{Qualitative validation}
\label{sec:qualitative}
A qualitative validation of the counting algorithm was performed using the following approach. The counted video sequences were evaluated with the following prejudices. In video sequences with only Sonazoid\texttrademark{} bubbles, no phase-shift bubbles should be counted. After the administration of the ACT\texttrademark{} dilution the phase-shift bubbles should stick and stay up to five minutes before decaying and disappearing. After the burst of high frequency ultrasound, all Sonazoid\texttrademark{} bubbles should be destroyed, but none of the phase-shift bubbles, i.e. the bubble count should not be affected by the high frequency ultrasound. The qualitative prejudices used to distinguish Sonazoid\texttrademark{} and phase-shift bubbles are stated in Table \ref{tab:qualitative}.


\begin{table}[H]
\caption{Prejudices used to distinguish Sonazoid\texttrademark{} and phase-shift bubbles.}
\label{tab:qualitative}
\begin{center}
\begin{tabular}{@{}l l l @{}}
  \toprule
  Property & Sonazoid\texttrademark{} & Phase-shift bubbles \\
  \midrule
  Non-linear imaging & Strong signal & Weak signal \\
  Linear imaging & Weak signal & Strong signal \\
  Kinetics & Free flowing & Stuck \\
  High power ultrasound & Destroyed &Unchanged\\
  \bottomrule
\end{tabular}
\end{center}
\end{table}


\subsection{Quantitative validation}
\subsubsection{Synthesized data set}
A quantitative validation of the algorithm was carried out by counting a synthesized data set with a known number density of activated phase-shift bubbles. Three different videos of administration of Sonazoid\texttrademark{} microbubbles were used as a background, and artificial phase-shift bubbles were added to create a data set with a known number density phase-shift bubbles. The number density ranged from \SIrange[per-mode=symbol]{0}{15}{bubbles\per\milli\meter\squared}. For each background, 27 data sets with increasing number density were constructed. The background images were acquired using linear contrast mode.

The algorithm adding the synthesized phase-shift bubbles to a background is described in the following paragraph. First, N random positions within the ROI is drawn from a uniform distribution. Then N intensities are drawn from a Gamma distribution (see Section \ref{PS intensity distribution}), and N frame numbers are drawn from a Poisson distribution to determine when the bubbles enter the tumor. N bubbles are then generated by applying the point spread function (PSF) to the drawn intensities. For each bubble the maximum intensity follows the slope of the bubble growth, shown in Figure \ref{Fig:growth slope}. These N bubbles are then log compressed and inserted into the video data. 


\begin{figure}[h]
  \centering
  \includegraphics[width=\linewidth]{fit of bubble growth.jpg}
  \caption{A growth slope is fit to data from an identified bubble in a true dataset.}
  \label{Fig:growth slope}
\end{figure}

\subsubsection{Phase-shift bubbles intensity distribution}
\label{PS intensity distribution}
A heuristic approach was used to estimate the intensity distribution for the activated phase-shift bubbles. In a set containing 63 identified phase-shift bubbles, the maximum intensity was plotted for each frame (Figure \ref{Fig:bubble_tic}). For each bubble the overall maximum value was used in a set, from which a gamma distribution was estimated (Figure \ref{Fig:gamma_fit}). 

The intensity distribution could probably been estimated through a more theoretical approach. However, the size distribution of activated emulsion droplets is not known accurately. The large phase-shift bubbles will also be deformed by the surroundings, and accurate backscattering and received signal from these bubbles are difficult to predict. A theoretical approach would therefore be based assumptions with unknown legitimacy. The heuristic approach was therefore considered to provide better results, and was chosen in favour. 


\begin{figure}[h]
  \centering
  \includegraphics[width=\linewidth]{bubble_tic.jpg}
  \caption{Time-intensity curves for a set of phase-shift bubbles.}
  \label{Fig:bubble_tic}
\end{figure}
\begin{figure}[h]
  \centering
  \includegraphics[width=\linewidth]{gamma_fit.jpg}
  \caption{The fit of a Gamma distribution to the distribution of maximum phase-shift bubble intensities.}
  \label{Fig:gamma_fit}
\end{figure}

\subsubsection{Measuring the point spread function}
The point spread function was measured from two different images. One image of a low solution of Sonazoid\texttrademark{} microbubbles in water, and another image of contamination in tap water. The size of the imaged microbubbles are smaller than the image system resolution. Thus, the bubbles visible in the image is effectively the PSF. A two dimensional, normalized Gaussian function was fit to a single, strong and easily identifiable bubble. 

% 
%\subsubsection{Measuring the scan plane height}
%The height of the ultrasound scan plan is necessary to calculate the number of phase-shift bubbles per volume. This height was measured by imaging a thin wire, running diagonally across the scan plane. The image is then a mapping of the string down on the x-axis. The height, H,  can the be calculated by measuring the length L, for a given angle $\Theta$.
%
%\begin{figure}[h]
%  \centering
%  \includegraphics[width=0.6\linewidth]{Transducer_scan_plane_height.pdf}
%  \caption{The measurement of transducer scan plane height}
%\end{figure}
%


\clearpage

